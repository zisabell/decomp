---
title: "Results"
author: "Isabelle van der Zanden and Gelieke Steeghs"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, echo = FALSE, warning = FALSE)
```

``` {r package}

library(Rmisc)
library(tidyverse)
library(kableExtra)
library(flextable)
library(ggpubr)
library(rstatix)
library(readxl)
library(writexl)
library(car)
# library(lme4) lmer from this package doesn't show p values
library(lmerTest)
library(wesanderson)
library(multcomp)
library(multcompView)
library(emmeans)
library(broom)
library(broom.mixed)
library(ggcorrplot)
library(reshape2)

```

``` {r upload and mutate files}
lml <- read_csv2("MASTER_LML.csv")

lml$litter_sp <- factor(lml$litter_sp, levels=c("Alder","Hazel","Chestnut"))
lml$mesh_size <- factor(lml$mesh_size, levels=c("Fine","Medium","Coarse"))

mt <- read_csv2("MASTERFILE_decomp_10.csv")

mt_2 <- mt %>% mutate(age = 2021-year_of_landuse,
                      earthworms_2021 = compost_worms + soil_eating_worms + pendelaars)

mt_2 <- mt_2 %>% rowwise() %>% dplyr::mutate(earthworms_2022 = sum(dplyr::c_across(contains("Abundance"))))
mt_2 <- mt_2 %>% dplyr::rename("vb_code" = "code")

# join litter mass data with landuse & location data
mt_2_lu_loc <- mt_2 %>% dplyr::select(vb_code, landuse, location)
lml_2 <- lml %>% left_join(mt_2_lu_loc, by ="vb_code")

# filter out only the 4 subplots that have been used for the litter mass experiment
mt_3 <- mt_2 %>% filter(plot_nr < 5)

# sum columns mites and earthworms
mt_4 <- cbind(mt_3, mites_sum = rowSums(mt_3[c('Mites_oribatid_kg','Mites_other_kg')]))
mt_4 <- cbind(mt_4, biomass_ew_total = rowSums(mt_3[c('Biomass_anecic','Biomass_endogeic','Biomass_epigeic','Biomass_juvenile')]))

```

# Results

Average AMF biomass in grassland was `r format(mt_4 %>% filter(landuse == "Grassland") %>% summarize(mean = mean(AMF_NLFA, na.rm=TRUE)), digits=2)` ug/gr. (example)

``` {r table}

# set_flextable_defaults(
#   font.size = 12, font.family = "Open Sans",
#   font.color = "#333333",
#   table.layout = "fixed",
#   border.color = "gray",
#   padding.top = 3, padding.bottom = 3,
#   padding.left = 4, padding.right = 4)

# # run ANOVA for ph_kcl as a test
# mt_4.lmeFit <- lmer(ph_kcl ~ landuse + (1|location),data=mt_4, na.action = "na.omit")
# anova(mt_4.lmeFit)
# 
# cld(lsmeans(mt_4.lmeFit,~ landuse,adjust="tukey"), Letters = c(letters))

# list of model outputs ANOVA
models <- list()
for (i in c('ph_kcl','som_percentage','b.d.','moisture_percentage','NO2_NO3_mg_kg','NH4_mg_kg',
            'Total_P_mg_kg','Olsen_P_mg_kg','earthworms_2022','biomass_ew_total',
            'Springtails_nr_kg','Mites_oribatid_kg','Mites_other_kg',
            'Bacteria_total','Microbial','Actinobacteria_total','Fungi_total','Total_plfa','AMF_NLFA')) {
  f <- formula(paste(i,"~ landuse + (1|location)"))
  models[[i]] <- lmer(f, data=mt_4, na.action = "na.omit")
}
  
# cld(lsmeans(models$AMF_NLFA,~ landuse, adjust="tukey"), Letters = c(letters))

tab_order <- c('b.d.','moisture_percentage','ph_kcl','som_percentage','NO2_NO3_mg_kg','NH4_mg_kg',
               'Total_P_mg_kg', 'Olsen_P_mg_kg','Bacteria_total','Microbial',               
               'Actinobacteria_total', 'Fungi_total','Total_plfa','AMF_NLFA',
               'Springtails_nr_kg','Mites_oribatid_kg','Mites_other_kg',
               'earthworms_2022','biomass_ew_total')

mt_wide <- mt_4 %>% pivot_longer(cols=c(ph_kcl:b.d.,
                                        NO2_NO3_mg_kg:Olsen_P_mg_kg,
                                        Bacteria_total:Springtails_nr_kg,
                                        earthworms_2022,biomass_ew_total), names_to="measurement")
mt_wide <- mt_wide %>% mutate(category = if_else(measurement=='b.d.'|measurement=='moisture_percentage',
                                                 "Physical",
                                                 if_else(measurement=='ph_kcl'|measurement=='som_percentage'|
                                                measurement=='NO2_NO3_mg_kg'|measurement=='NH4_mg_kg'|
                                                measurement=='Total_P_mg_kg'|measurement== 'Olsen_P_mg_kg',
                                              "Chemical",
                                              if_else(measurement=='Bacteria_total'|measurement=='Microbial'|
                                                       measurement=='Actinobacteria_total'|
                                                       measurement=='Fungi_total'|measurement=='Total_plfa'|
                                                       measurement=='AMF_NLFA',"Microbial biomass",
                                              if_else(measurement=='Springtails_nr_kg'|
                                                       measurement=='Mites_oribatid_kg'|
                                                       measurement=='Mites_other_kg',
                                                     "Micro-arthropod","Earthworms")
                                              ))))

tab <- mt_wide %>% group_by(landuse, category, measurement) %>%
  summarise(mean = sprintf("%1.2f", mean(value, na.rm = TRUE)),
            sd = sprintf("(%1.2f)", sd(value, na.rm = TRUE))) %>%
  unite("value",mean, sd, sep=" ") %>%
  arrange(factor(measurement, levels = tab_order)) %>%
  pivot_wider(names_from=landuse, values_from=value)

# #alternative way
# x <- mt_wide %>% group_by(landuse, category, measurement) %>% 
#   summarise(
#     across(.cols = 'value',
#            .fns = list(
#              mean = ~ mean(.x, na.rm = TRUE),
#              sd = ~ sd(.x, na.rm = TRUE)
#            )), .groups = "drop")

tab %>% 
  flextable() %>% 
  labelizor(labels = c(category = "Category", measurement = "Measurements", Food_forest = "Food forest", 
                       NH4_mg_kg = "Ammonium (mg/kg)", NO2_NO3_mg_kg = "Nitrite and Nitrate (mg/kg)",
                       Total_P_mg_kg = "Total fosfor (mg/kg)", Olsen_P_mg_kg = "Olsen P (mg/kg)", 
                       b.d. = "Bulk density (g/cm3)", ph_kcl = "pH-KCl", 
                       moisture_percentage = "Soil moisture (%)", 
                       som_percentage = "Soil organic matter (%)", 
                       earthworms_2022 = "Earthworms abundance (#/0.1m2)",
                       biomass_ew_total = "Earthworms biomass (g/0.1m2)",
                       Springtails_nr_kg = "Springtails abundance (#/kg)", 
                       Mites_oribatid_kg = "Mites oribatid abundance (#/kg)",
                       Mites_other_kg = "Mites other abundance (#/kg)",
                       Bacteria_total = "Bacteria (µg/g)", Microbial = "Microbial (µg/g)",
                       Actinobacteria_total = "Actinobacteria (µg/g)", Fungi_total = "Non-AMF fungi (µg/g)",
                       Total_plfa = "Total PFLA (µg/g)", AMF_NLFA = "AMF from NFLA (µg/g)")) %>%
  merge_v(j = ~ category) %>% 
  hline(j = ~ category, part = "all") %>%
  set_table_properties(layout = "autofit")

```

## PLFA/NLFA biomass microbial groups  


``` {r plot, stacked bar microbial groups, fig.dim = c(10,8)}

mt_plfa_long <- mt_2 %>% pivot_longer(cols=c(Bacteria_total, Actinobacteria_total, Fungi_total, AMF_NLFA),
                                      names_to="Groups",values_to="concentration")

# mt_plfa_long$location <- factor(mt_plfa_long$location, levels = c("Haarzuilens", "Vlaardingen","Boelenslaan", "Amsterdam"),
#                   labels = c("Location 1", "Location 2", "Location 3", "Location 4"))

mt_plfa_long %>% 
  group_by(landuse, Groups) %>%
  summarize(average = mean(concentration), .groups="drop") %>%
  ggplot(aes(x=landuse, y=average, fill=Groups)) + 
  geom_col(width=0.6) +
  scale_fill_manual(values=wes_palette("Cavalcanti1"), labels=c("Actinobacteria",
                                                                "AMF",
                                                                "Bacteria",
                                                                "Fungi")) +
  theme_minimal(base_size = 18) +
  theme(legend.position="top") +
  scale_x_discrete(labels=c("Food forest", "Grassland")) +
  labs(x="Landuse", y="Average estimation microbial biomass (ug/gr of soil)",  fill="Microbial groups")

# Run ANOVAs to test for the effect of land use vs location -> need to make figures out of this
# AMF_NLFA is the only one significant for land use
mt_2.lmeFit <- lmer(AMF_NLFA ~ landuse + (1|location),data=mt_2, na.action = "na.omit")
anova(mt_2.lmeFit)
cld(lsmeans(mt_2.lmeFit,~ landuse,adjust="tukey"), Letters = c(letters))
# Bacteria_total is the only one significant for location
mt_2.lmeFit <- lmer(Bacteria_total ~ location + (1|location),data=mt_2, na.action = "na.omit")
anova(mt_2.lmeFit)
cld(lsmeans(mt_2.lmeFit,~ location,adjust="tukey"), Letters = c(letters))

```

## Earthworm biomass functional groups  

``` {r plot, boxplot earthworm biomass, fig.dim = c(10,8)}

mt_4 %>% 
  group_by(landuse) %>%
  ggplot(aes(x=landuse, y=earthworms_2022, fill=landuse)) + 
  geom_boxplot(outlier.shape=NA, alpha=0.6) +
  geom_jitter(width=0.2, shape = 16, fill = "black",
             size = 3) + 
  scale_fill_manual(values=c("#0072B2","#009E73")) +
  theme_minimal(base_size = 18) +
  theme(legend.position="none", panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank()) +
  scale_x_discrete(labels=c("Food forest", "Grassland")) +
  labs(x="Landuse", y="Average earthworm biomass (gr/0.1m2)")

```

# Statistics

## Litter mass loss data - Litter species x mesh size x land use

``` {r statistics litter mass loss, fig.dim = c(10,8)}

# Descriptive statistics
# summarySE(lml_2, measurevar="litter_mass_loss_final", na.rm=TRUE)
summarySE(lml_2, measurevar="litter_mass_loss_final", groupvars=c("landuse"), na.rm=TRUE)

# Levene's test for homogeneity of variances
lml_2 %>% group_by(landuse, location, litter_sp, mesh_size) %>%
          summarize(mean=mean(litter_mass_loss_final, na.rm=TRUE),
                    sd=sd(litter_mass_loss_final, na.rm=TRUE),
                    var=var(litter_mass_loss_final, na.rm=TRUE))
variances_lml_lu_loc <- leveneTest(litter_mass_loss_final ~ 
                                     landuse * location * litter_sp * mesh_size, data = lml_2)
variances_lml_lu_loc

# variances_lml_lu <- leveneTest(litter_mass_loss_final ~ landuse, data = lml_2)
# variances_lml_lu

# Histogram of the raw data
gghistogram(lml_2, x='litter_mass_loss_final', fill = 'lightgrey', na.rm=TRUE)

# Three-way ANOVA
threeway.lmeFit <- lmer(litter_mass_loss_final ~ landuse * litter_sp * mesh_size + (1|location/landuse/vb_code),data=lml_2, 
                      na.action = "na.omit")
summary(threeway.lmeFit)
augmented_threeway <- augment(threeway.lmeFit)
ggplot(augmented_threeway, aes(x = .fitted, y = .resid)) + 
  geom_point()
outlierTest(threeway.lmeFit) # sample from line 115 is outlier?
anova(threeway.lmeFit)
# Three-way interaction letters are there but it looks kind of messy (probably better to do it manually again)
threeway_cld <- cld(lsmeans(threeway.lmeFit,~ landuse * litter_sp * mesh_size,adjust="tukey"), Letters = c(letters))
threeway_cld

# Three-way ANOVA, different function that includes p-value in the output (but also different output compared to the other anova function)
threeway_aov <- aov(litter_mass_loss_final ~ landuse * litter_sp * mesh_size + (1:location/landuse/vb_code), data=lml_2, na.action = "na.omit")
summary(threeway_aov)

# Testing the residuals
ggqqplot(residuals(threeway.lmeFit))
shapiro.test(residuals(threeway.lmeFit)) # it is significant...

# Arcsine transformation (does not seem to make any difference)
lml_3 <- lml_2
lml_3$litter_mass_loss_final <- asin(sqrt(lml_2$litter_mass_loss_final))
threeway_3.lmeFit <- lmer(litter_mass_loss_final ~ landuse * litter_sp * mesh_size + (1|location/landuse),data=lml_3, 
                      na.action = "na.omit")
ggqqplot(residuals(threeway_3.lmeFit))
shapiro.test(residuals(threeway_3.lmeFit))

# Plot the outcomes
image <- lml_2 %>% group_by(mesh_size, litter_sp) %>%
  ggplot(aes(x=landuse, y=litter_mass_loss_final, fill=landuse)) +
  geom_boxplot(outlier.shape = NA, alpha=0.8, show.legend = FALSE) +
  scale_fill_manual(values=wes_palette("Royal1"), labels=c("Food forest","Grassland")) + 
  geom_point(position = position_jitterdodge(0.4), 
             pch=16, color="black",show.legend = FALSE) +
  geom_text(data = threeway_cld, aes(x = landuse, y = upper.CL, label = .group)) +
  scale_fill_manual(values=c("#549E39","#ffa600")) +
  facet_grid(litter_sp ~ mesh_size) +
  theme_bw(base_size = 16) +
  scale_x_discrete(labels=c("Food forest", "Grassland")) +
  labs(y="Litter mass loss (%)", x="Land use", fill="Landuse")

ggsave(file="3x3plot_flipped.svg", plot=image, width=10, height=10)


``` 

## Litter mass loss data - Litter species x mesh size

```{r statistics litterxmesh}

# Two-way ANOVAs (for significance letters)
## Litter species x Mesh size
litter_mesh.lmeFit <- lmer(litter_mass_loss_final ~ litter_sp * mesh_size + (1|location/landuse/vb_code),data=lml_2,
                      na.action = "na.omit")
summary(litter_mesh.lmeFit)
anova(litter_mesh.lmeFit)
cld(lsmeans(litter_mesh.lmeFit,~ litter_sp * mesh_size, adjust="tukey"), Letters = c(letters))

# Testing the residuals
ggqqplot(residuals(litter_mesh.lmeFit))
shapiro.test(residuals(litter_mesh.lmeFit))
```

## Litter mass loss data - Alder (Mesh size x Land use)

```{r statistics alder}
# Two-way ANOVAs (for significance letters)
# Testing for each litter species individually. A lot of copy pasta spaghetti code, hope to make this more 
# streamlined still

#lml_2_litter.lmeFit <- lmer(litter_mass_loss_final ~ mesh_size * landuse + #(1|location/landuse/vb_code),data=lml_2_litter, 
 #                     na.action = "na.omit")
#anova(lml_2_litter.lmeFit)

lml_2_alder <- lml_2 %>%
  dplyr::filter(litter_sp == "Alder")
alder.lmeFit <- lmer(litter_mass_loss_final ~ mesh_size * landuse + (1|location/landuse/vb_code),data=lml_2_alder, 
                      na.action = "na.omit")
summary(alder.lmeFit)
anova(alder.lmeFit)
cld(lsmeans(alder.lmeFit,~ mesh_size * landuse, adjust="tukey"), Letters = c(letters))

# Descriptive statistics
summarySE (lml_2_alder, measurevar="litter_mass_loss_final", na.rm=TRUE)
summarySE (lml_2_alder, measurevar="litter_mass_loss_final", groupvars=c("landuse"), na.rm=TRUE)

# Levene's test for homogeneity of variances
variances_lml_lu_loc <- leveneTest(litter_mass_loss_final ~ landuse * location, data = lml_2_alder)
variances_lml_lu_loc

# Histogram of the raw data
gghistogram(lml_2_alder, x='litter_mass_loss_final', fill = 'lightgrey', na.rm=TRUE)

# Residuals
ggqqplot(residuals(alder.lmeFit))
shapiro.test(residuals(alder.lmeFit))
```

## Litter mass loss data - Hazel (Mesh size x Land use)

```{r statistics hazel}

lml_2_hazel <- lml_2 %>%
  dplyr::filter(litter_sp == "Hazel")
hazel.lmeFit <- lmer(litter_mass_loss_final ~ mesh_size * landuse + (1|location/landuse/vb_code),data=lml_2_hazel, 
                      na.action = "na.omit")
anova(hazel.lmeFit)
cld(lsmeans(hazel.lmeFit,~ mesh_size * landuse, adjust="tukey"), Letters = c(letters))

# Descriptive statistics
summarySE (lml_2_hazel, measurevar="litter_mass_loss_final", na.rm=TRUE)
summarySE (lml_2_hazel, measurevar="litter_mass_loss_final", groupvars=c("landuse"), na.rm=TRUE)

# Levene's test for homogeneity of variances
variances_lml_lu_loc <- leveneTest(litter_mass_loss_final ~ landuse * location, data = lml_2_hazel)
variances_lml_lu_loc

# Histogram of the raw data
gghistogram(lml_2_hazel, x='litter_mass_loss_final', fill = 'lightgrey', na.rm=TRUE)

# Residuals
ggqqplot(residuals(hazel.lmeFit))
shapiro.test(residuals(hazel.lmeFit))

```

## Litter mass loss data - Chestnut (Mesh size x Land use)

```{r statistics chestnut}

lml_2_chestnut <- lml_2 %>%
  dplyr::filter(litter_sp == "Chestnut")
chestnut.lmeFit <- lmer(litter_mass_loss_final ~ mesh_size * landuse + (1|location/landuse/vb_code),data=lml_2_chestnut, na.action = "na.omit")
anova(chestnut.lmeFit)
cld(lsmeans(chestnut.lmeFit,~ mesh_size * landuse, adjust="tukey"), Letters = c(letters))

# Descriptive statistics
summarySE (lml_2_chestnut, measurevar="litter_mass_loss_final", na.rm=TRUE)
summarySE (lml_2_chestnut, measurevar="litter_mass_loss_final", groupvars=c("landuse"), na.rm=TRUE)

# Levene's test for homogeneity of variances
variances_lml_lu_loc <- leveneTest(litter_mass_loss_final ~ landuse * location, data = lml_2_chestnut)
variances_lml_lu_loc

# Histogram of the raw data
gghistogram(lml_2_chestnut, x='litter_mass_loss_final', fill = 'lightgrey', na.rm=TRUE)

# Residuals
ggqqplot(residuals(chestnut.lmeFit))
shapiro.test(residuals(chestnut.lmeFit))

```


# Supplement

## Correlation matrix variables  

```{r correlation matrix, fig.dim=c(12,12)}
corr <- round(cor(mt_4 %>% dplyr::select(c('ph_kcl','som_percentage','b.d.','moisture_percentage',
                                           'NO2_NO3_mg_kg','NH4_mg_kg',
            'Total_P_mg_kg','Olsen_P_mg_kg','earthworms_2022','biomass_ew_total',
            'Springtails_nr_kg','Mites_oribatid_kg','Mites_other_kg','nr_nematodes_gr_dry',
            'Bacteria_total','Microbial','Actinobacteria_total','Fungi_total','Total_plfa','AMF_NLFA')),
            use='pairwise.complete.obs'), 1)

# automatic ggcorrplot
# ggcorrplot(corr, method = "circle")

# Get lower triangle of the correlation matrix
  get_lower_tri<-function(corr){
    corr[upper.tri(corr)] <- NA
    return(corr)
  }
  # Get upper triangle of the correlation matrix
  get_upper_tri <- function(corr){
    corr[lower.tri(corr)]<- NA
    return(corr)
  }

lower_tri <- get_lower_tri(corr)

# more adjustable ggplot version
ggplot(melt(lower_tri, na.rm=TRUE), aes(Var1, Var2, fill=value)) +
  geom_tile(height=0.8, width=0.8) +
  scale_fill_gradient2(low="blue", mid="white", high="red", limits=c(-1,1)) +
  theme_minimal() +
  coord_equal() +
  labs(x="",y="",fill="Corr") +
  theme(axis.text.x=element_text(size=18, angle=45, vjust=1, hjust=1, 
                                 margin=margin(-3,0,0,0)),
        axis.text.y=element_text(size=18, margin=margin(0,-3,0,0)),
        panel.grid.major=element_blank(),
        legend.justification = c(1, 0),
        legend.position = c(0.6, 0.7),
        legend.direction = "horizontal") +
  geom_text(aes(Var1, Var2, label = value), color = "black", size = 4)


``` 


``` {r multiple regression}
#Alder

mr_alder <- lml %>% filter(litter_sp == "Alder" & mesh_size == "Coarse") %>%
                  left_join(mt_4, by = "vb_code")

mult_regr_alder <- lm(litter_mass_loss_final ~ ph_kcl + b.d. + NH4_mg_kg + Olsen_P_mg_kg + biomass_ew_total + Springtails_nr_kg + mites_sum + Total_plfa + AMF_NLFA, data = mr_alder)

summary(mult_regr_alder)

#Hazel
mr_hazel <- lml %>% filter(litter_sp == "Hazel" & mesh_size == "Coarse") %>%
                  left_join(mt_4, by = "vb_code")

mult_regr_hazel <- lm(litter_mass_loss_final ~ ph_kcl + b.d. + NH4_mg_kg + Olsen_P_mg_kg + biomass_ew_total + Springtails_nr_kg + mites_sum + Total_plfa + AMF_NLFA, data = mr_hazel)

summary(mult_regr_hazel)

#Chestnut
mr_chestnut <- lml %>% filter(litter_sp == "Chestnut" & mesh_size == "Coarse") %>%
                  left_join(mt_4, by = "vb_code")

mult_regr_chestnut <- lm(litter_mass_loss_final ~ ph_kcl + b.d. + NH4_mg_kg + Olsen_P_mg_kg + biomass_ew_total + Springtails_nr_kg + mites_sum + Total_plfa + AMF_NLFA, data = mr_chestnut)

summary(mult_regr_chestnut)

``` 

