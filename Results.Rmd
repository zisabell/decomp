---
title: "Results"
author: "Isabelle van der Zanden and Gelieke Steeghs"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, echo = FALSE, warning = FALSE)
```

``` {r package}
# library(Rmisc)
library(tidyverse)
# library(kableExtra)
library(flextable)
# library(ggpubr)
# library(rstatix)
# library(readxl)
# library(writexl)
library(car)
# library(wesanderson)
library(multcomp)
# library(multcompView)
library(emmeans)
# library(broom)
# library(broom.mixed)
# library(ggcorrplot)
# library(reshape2)
# library(lmerTest)
library(factoextra)
library(vegan)
# library(GGally)
# library(ggpmisc)
# library(RColorBrewer)
library(lme4)
library(glmmTMB)
library(DHARMa)
library(ggbeeswarm)
```

``` {r upload and mutate files}
lml <- read_csv2("MASTER_LML.csv")

lml$litter_sp <- factor(lml$litter_sp, levels=c("Alder","Hazel","Chestnut"))
lml$mesh_size <- factor(lml$mesh_size, levels=c("Fine","Medium","Coarse"))
# lml <- lml %>% mutate(litter_mass_loss_final = litter_mass_loss_final*100)

mt <- read_csv2("MASTERFILE_decomp_10.csv")
cnp <- read_csv("CNP_data.csv")

litter_cn <- read_csv2("litter_cn.csv")
litter_lignin <- read_csv2("litter_lignin.csv")
litter_lignin <- litter_lignin %>% dplyr::rename("lignin" = "lignin (mg/g)")

mt_1 <- mt %>% left_join(cnp, by="code")

mt_2 <- mt_1 %>% mutate(age = 2021-year_of_landuse,
                      earthworms_2021 = compost_worms + soil_eating_worms + pendelaars)

mt_2 <- mt_2 %>% rowwise() %>% dplyr::mutate(earthworms_2022 = sum(dplyr::c_across(contains("Abundance")))*10)
mt_2 <- mt_2 %>% dplyr::rename("vb_code" = "code")

# join litter mass data with landuse & location data
mt_2_lu_loc <- mt_2 %>% dplyr::select(vb_code, landuse, location)
lml_2 <- lml %>% left_join(mt_2_lu_loc, by ="vb_code")

# filter out only the 4 subplots that have been used for the litter mass experiment
# mt_3 <- mt_2 %>% filter(plot_nr < 5)

# sum columns mites and earthworms
mt_4 <- cbind(mt_2, mites_sum = rowSums(mt_2[c('Mites_oribatid_kg','Mites_other_kg')]))
mt_4 <- cbind(mt_4, biomass_ew_total = rowSums(mt_2[c('Biomass_anecic','Biomass_endogeic','Biomass_epigeic','Biomass_juvenile')])*10)

# sum bacteria + actinos
mt_4 <- cbind(mt_4, bact_total = rowSums(mt_4[c("Bacteria_total","Actinobacteria_total")]))

#CN ratio
mt_4$CN <- mt_4$C_total/mt_4$N_total

#loclu
mt_4$location <- factor(mt_4$location)
levels(mt_4$location) <- c("L4","L3","L1", "L2")

mt_4$loc_lu <- paste(mt_4$location, mt_4$landuse, sep="_")

# join litter mass data with physical, chemical, biological data
lml_mt <- lml_2 %>% left_join(mt_4, by ="vb_code")
```

# Results

## Soil characteristics  
When comparing soil characteristics between food forests and grasslands significant differences were found with higher moisture and soil organic matter content, lower bulk density, higher oribatid and other (mesostigmatic and prostigmatic) mite abundance for food forests, but significantly higher earthworm abundance and biomass and higher AMF biomass for grasslands. No significant differences were found for pH, nutrient concentrations (C, N, P), springtail abundance and fungal (non-AMF), bacterial, actinobacterial, general microbial biomass and total microbial biomass (table 1). 

<!-- Average AMF biomass in grassland was `r format(mt_4 %>% filter(landuse == "Grassland") %>% summarize(mean = mean(AMF_NLFA, na.rm=TRUE)), digits=2)` ug/gr. (example) -->

``` {r table}
#This code can go out here because it's in norvar_check?:
# list of model outputs ANOVA
models <- list()
for (i in c('ph_kcl','som_percentage','b.d.','moisture_percentage', 'ec',
            'Total_P_mg_kg','Olsen_P_mg_kg','C_total','N_total', 
            'earthworms_2022','biomass_ew_total',
            'Springtails_nr_kg','Mites_oribatid_kg','Mites_other_kg',
            'bact_total','Fungi_total','AMF_NLFA', 'CN')) {
  f <- formula(paste(i,"~ landuse + (1|location/landuse)"))
  models[[i]] <- lmer(f, data=mt_4, na.action = "na.omit")
}

tab_order <- c('b.d.','moisture_percentage','ph_kcl','som_percentage', 'ec',
               'Total_P_mg_kg', 'Olsen_P_mg_kg','C_total','N_total','CN',
               'bact_total','AMF_NLFA','Fungi_total',              
               'Springtails_nr_kg','Mites_oribatid_kg','Mites_other_kg',
               'earthworms_2022','biomass_ew_total')

mt_wide <- mt_4 %>% pivot_longer(cols=c(ec,ph_kcl:b.d.,
                                        Total_P_mg_kg:Olsen_P_mg_kg,
                                        Fungi_total, AMF_NLFA:Springtails_nr_kg,
                                        C_total:CN,
                                        earthworms_2022,biomass_ew_total,bact_total), names_to="measurement")
mt_wide <- mt_wide %>% mutate(category = if_else(measurement=='b.d.'|measurement=='moisture_percentage',
                                                 "Physical",
                                                 if_else(measurement=='ph_kcl'|measurement=='som_percentage'|measurement=='ec'|
                                                measurement=='Total_P_mg_kg'|measurement== 'Olsen_P_mg_kg'|measurement=="C_total"|measurement=="N_total"|measurement=="CN",
                                              "Chemical","Biological")))
                                              # if_else(measurement=='Bacteria_total'|measurement=='Microbial'|
                                              #          measurement=='Actinobacteria_total'|
                                              #          measurement=='Fungi_total'|measurement=='Total_plfa'|
                                              #          measurement=='AMF_NLFA',"Microbial biomass",
                                              # if_else(measurement=='Springtails_nr_kg'|
                                              #          measurement=='Mites_oribatid_kg'|
                                              #          measurement=='Mites_other_kg',
                                              #        "Micro-arthropod","Earthworms")
                                              # ))))

tab <- mt_wide %>% group_by(landuse, category, measurement) %>%
  summarise(mean = sprintf("%1.2f", mean(value, na.rm = TRUE)),
            sd = sprintf("(%1.2f)", sd(value, na.rm = TRUE))) %>%
  unite("value",mean, sd, sep=" ") %>%
  arrange(factor(measurement, levels = tab_order)) %>%
  pivot_wider(names_from=landuse, values_from=value)

# #alternative way
# x <- mt_wide %>% group_by(landuse, category, measurement) %>% 
#   summarise(
#     across(.cols = 'value',
#            .fns = list(
#              mean = ~ mean(.x, na.rm = TRUE),
#              sd = ~ sd(.x, na.rm = TRUE)
#            )), .groups = "drop")

tab %>% 
  flextable() %>% 
  labelizor(labels = c(category = "Category", measurement = "Measurements", Food_forest = "Food forest", 
                       Total_P_mg_kg = "Total fosfor (mg/kg)", Olsen_P_mg_kg = "Olsen P (mg/kg)", 
                       b.d. = "Bulk density (g/cm3)", ph_kcl = "pH (KCl)", ec="Electrical conductivity (mS/m)",
                       C_total = "Total C (%)", N_total = "Total N (%)", CN = "C:N ratio",
                       moisture_percentage = "Soil moisture (%)", 
                       som_percentage = "Soil organic matter (%)", 
                       earthworms_2022 = "Earthworms abundance (#/m2)",
                       biomass_ew_total = "Earthworms biomass (g/m2)",
                       Springtails_nr_kg = "Springtails abundance (#/kg)", 
                       Mites_oribatid_kg = "Mites oribatid abundance (#/kg)",
                       Mites_other_kg = "Mites other abundance (#/kg)",
                       bact_total = "Bacterial biomass (µg/g)",
                       Fungi_total = "Non-AMF fungal biomass (µg/g)",
                       AMF_NLFA = "AMF biomass (µg/g)")) %>%
  merge_v(j = ~ category) %>% 
  hline(j = ~ category, part = "all") %>%
  set_table_properties(layout = "autofit") %>%
  set_caption(caption = "Table 1. ANOVA results comparing food forests to grasslands for chemical, physical and biological variables. Table shows mean (standard deviation), F statistic and p-values.", 
                  style = "Table Caption")

```

## Litter characteristics 

``` {r litter cn lignin table}
# Litter CN data statistics
litter_cn %>% 
  group_by(litter_species) %>%
  summarize(
    mean1 = mean(c_proc),
    sd1 = sd(c_proc),
    mean2 = mean(n_proc),
    sd2 = sd(n_proc),
    mean3 = mean(cn_ratio),
    sd3 = sd(cn_ratio),
  )

cn.lm <- lm(cn_ratio ~ litter_species, data=litter_cn)
summary(cn.lm)
cn_anova <- anova(cn.lm)
cn_anova

cld(emmeans(cn.lm,~ litter_species,adjust="tukey"), Letters = c(letters))

# Litter lignin data statistics

litter_lignin %>% 
  group_by(litter_species) %>%
  summarize(
    min = min(lignin),
    max = max(lignin),
    mean = mean(lignin),
    sd = sd(lignin)
  )

lignin.lm <- lm(lignin ~ litter_species, data=litter_lignin)
summary(lignin.lm)
lignin_anova <- anova(lignin.lm)
cld(emmeans(lignin.lm,~ litter_species,adjust="tukey"), Letters = c(letters))

# C
c.lm <- lm(c_proc ~ litter_species, data=litter_cn)
hist(residuals(c.lm))
shapiro.test(residuals(c.lm))
anova(c.lm)
cld(emmeans(c.lm,~ litter_species,adjust="tukey"), Letters = c(letters))

# N
n.lm <- lm(n_proc ~ litter_species, data=litter_cn)
hist(residuals(n.lm))
anova(n.lm)
cld(emmeans(n.lm,~ litter_species,adjust="tukey"), Letters = c(letters))

```

## Litter mass loss data  
An interaction between land use, litter species and mesh size was observed for litter mass loss in coarse chestnut litter bags in grassland sites. Litter mass loss was lowest here. 
Litter mass loss was highest for hazel with medium and coarse mesh size and alder with the coarse mesh size. Medium levels of litter mass loss were found for hazel with fine mesh size and alder with fine and medium mesh size. Lowest levels of litter mass loss found for chestnut leaves for all mesh sizes. Effect of land use clear for alder with the coarse mesh size. Higher values were found in grasslands than food forests. 

``` {r statistics litter mass loss, fig.dim = c(10,8)}

# Descriptive statistics
# summarySE(lml_2, measurevar="litter_mass_loss_final", na.rm=TRUE) # for overall summary
# summarySE(lml_2, measurevar="litter_mass_loss_final", groupvars=c("landuse"), na.rm=TRUE)

# Levene's test for homogeneity of variances
lml_2 %>% group_by(landuse, location, litter_sp, mesh_size) %>%
          summarize(mean=mean(litter_mass_loss_final, na.rm=TRUE),
                    sd=sd(litter_mass_loss_final, na.rm=TRUE),
                    var=var(litter_mass_loss_final, na.rm=TRUE))
                    
variances_lml <- leveneTest(litter_mass_loss_final ~ landuse * location, data = lml_2)
variances_lml

# Histogram of the raw data
gghistogram(lml_2, x='litter_mass_loss_final', fill = 'lightgrey', na.rm=TRUE)

# Three-way ANOVA
threeway_slopes <- lmerTest::lmer(litter_mass_loss_final ~ landuse * litter_sp * mesh_size + (1 + location|landuse),data=lml_2, na.action = "na.omit")
threeway.lmeFit <- lmerTest::lmer(litter_mass_loss_final ~ landuse * litter_sp * mesh_size + (1|location/landuse),data=lml_2, na.action = "na.omit")
summary(threeway_slopes)
augmented_threeway <- augment(threeway.lmeFit)
ggplot(augmented_threeway, aes(x = .fitted, y = .resid)) + 
  geom_point()
outlierTest(threeway.lmeFit) # sample from line 115 is outlier?
threeway_anova <- anova(threeway.lmeFit)
anova(threeway.lmeFit,threeway_slopes)

# ANOVA results in table (still need to manually replace the significant and very small P-values by <0.0001)
litter_tab <- threeway_anova[,3:6]
litter_tab <- cbind(rownames(litter_tab), data.frame(litter_tab, row.names=NULL))
colnames(litter_tab)[1] <- "Parameter"

table_test <- litter_tab %>%
  flextable %>%
    labelizor(labels = c(landuse = "Land use", litter_sp = "Litter species", mesh_size = "Mesh size", 'landuse:litter_sp' = "Land use x Litter species", 'landuse:mesh_size' = "Land use x Mesh size", 'litter_sp:mesh_size' = "Litter species x Mesh size", 'landuse:litter_sp:mesh_size' = "Land use x Litter species x Mesh size", NumDF = "Num. DF", DenDF = "Den. DF", F.value = "F-value", Pr..F. = "P-value")) %>%
      colformat_double(j = c("DenDF"), digits = 0) %>%
        colformat_double(j = c("F.value", "Pr..F."), digits = 3) %>%
          set_table_properties(layout = "autofit") %>%
  set_caption(caption = "Table 2. ANOVA results comparing litter mass loss with an interaction effect between land use, litter species and mesh size, including degrees of freedom, F statistic and p-values.", 
                  style = "Table Caption")
table_test

# Three-way interaction letters are there but it looks kind of messy (probably better to do it manually again)
threeway_cld <- cld(emmeans(threeway.lmeFit,~ landuse * litter_sp * mesh_size,adjust="tukey"), Letters = c(letters))
threeway_cld

# Testing the residuals
ggqqplot(residuals(threeway.lmeFit))
shapiro.test(residuals(threeway.lmeFit)) # it is significant...

# # Arcsine transformation (does not seem to make any difference)
# lml_3 <- lml_2
# lml_3$litter_mass_loss_final <- asin(sqrt(lml_2$litter_mass_loss_final))
# threeway_3.lmeFit <- lmer(litter_mass_loss_final ~ landuse * litter_sp * mesh_size + (1|location/landuse),data=lml_3, 
#                       na.action = "na.omit")
# ggqqplot(residuals(threeway_3.lmeFit))
# shapiro.test(residuals(threeway_3.lmeFit))

# Plot the outcomes
image <- lml_2 %>% group_by(mesh_size, litter_sp) %>%
  ggplot(aes(x=landuse, y=litter_mass_loss_final, fill=landuse)) +
  geom_boxplot(outlier.shape = NA, alpha=0.8, show.legend = FALSE) +
  scale_fill_manual(values=c("#33A02B","#FF7F00"),
                    labels=c("Food forest","Grassland")) + 
  geom_point(position = position_jitterdodge(0.4), 
             pch=16, color="black",show.legend = FALSE) +
  # geom_text(data = threeway_cld, aes(x = landuse, y = upper.CL, label = .group)) +
  facet_grid(litter_sp ~ mesh_size) +
  theme_bw(base_size = 20) +
  scale_x_discrete(labels=c("Food forest", "Grassland")) +
  labs(y="Litter mass loss", x="Land use", fill="Landuse")
image
ggsave(file="3x3plot_no_letters.png", plot=image, width=10, height=10)
``` 

```{r three way}
#take NAs out
lml_3 <- filter(lml_2, !is.na(litter_mass_loss_final))
#transform data necessary for different models
# lml_3 <- lml_3 %>% mutate(litter_mass_loss_final = ifelse(litter_mass_loss_final > 1,
#                                                          1, litter_mass_loss_final))
# lml_3$litter_mass_loss_final_no_0_1 <- pmin(pmax(lml_3$litter_mass_loss_final, 
#                                                  0.0001), 0.9999)
# lml_3$logit_mass_loss <- log(lml_3$litter_mass_loss_final_no_0_1 /
#                                (1 - lml_3$litter_mass_loss_final_no_0_1))

#different models
# three_way_gauss <- glmmTMB(litter_mass_loss_final ~ landuse * litter_sp * mesh_size 
#                                + (1|location), family=gaussian(), 
#                            data=lml_3, na.action="na.omit")
# three_way_gauss_logit <- glmmTMB(logit_mass_loss ~ landuse * litter_sp * mesh_size 
#                                + (1|location), family=gaussian(), 
#                                data=lml_3, na.action="na.omit") #TERRIBLE
three_way_gauss_disp <- glmmTMB(litter_mass_loss_final ~ landuse * litter_sp * 
                                  mesh_size + (1|location), 
                               family=gaussian, dispformula = ~ litter_sp,
                        data=lml_3, na.action="na.omit")
# three_way_gauss_arcsin <- lmer(asin(sqrt(litter_mass_loss_final)) ~ 
#                                  landuse * litter_sp * mesh_size 
#                                + (1|location), data=lml_3, na.action="na.omit")
# three_way_beta <- glmmTMB(litter_mass_loss_final_no_0_1 ~ landuse * litter_sp *
#                             mesh_size + (1|location), beta_family(), 
#                           dispformula = ~ litter_sp, data=lml_3, na.action="na.omit")
# three_way_zi <- glmmTMB(litter_mass_loss_final_no_0_1 ~ landuse * litter_sp * mesh_size 
#                      + (1|location), beta_family(), ziformula = ~1, 
#                      data=lml_3, na.action="na.omit")

anova(three_way_gauss_disp, three_way_gauss) #beta is best, gaussian with dispersion is also good
simres <- simulateResiduals(three_way_gauss_disp)
plot(simres) #no severe issues
plotResiduals(simres, lml_3$mesh_size)
emmip(three_way_gauss_disp, landuse ~ litter_sp | mesh_size )
emm <- emmeans(three_way_gauss_disp, ~ landuse * litter_sp * mesh_size, type="response", adjust="Tukey")
# joint_tests(three_way_gauss_disp) %>% flextable()
(contrasts <- contrast(emm, "pairwise", simple="each", combine = TRUE, adjust="Tukey"))
contrasts_df <- as.data.frame(contrasts)
pairs(emmeans(emm, ~ litter_sp, type="response", adjust="Tukey"))
three_way_cld <- cld(emmeans(three_way_gauss_disp, ~ landuse * litter_sp * mesh_size, adjust="Tukey"), Letters = letters)
three_way_cld

#visualize interaction effect
emm_df <- as.data.frame(emm)
ggplot(emm_df, aes(x = landuse, y = emmean, color = litter_sp, group = litter_sp)) +
  geom_point() +
  geom_line() +
  facet_wrap(~ mesh_size) +
  labs(y = "Estimated Mean", x = "landuse", color = "Litter species")

# Plot the outcomes
image <- lml_3 %>%
  ggplot(aes(x=landuse, y=litter_mass_loss_final, fill=landuse, color=landuse)) +
  geom_boxplot(outlier.shape = NA, alpha=0.5, show.legend = FALSE, width=0.5) +
  scale_fill_manual(values=c("#56B4E9", "#D55E00" ),
                    labels=c("Food forest","Grassland")) + 
  scale_color_manual(values=c("#56B4E9", "#D55E00" ),
                    labels=c("Food forest","Grassland")) + 
  geom_beeswarm(aes(color = landuse), dodge.width = 1, cex = 2.5) +
  geom_point(
    data = three_way_cld,
    aes(y = emmean, x = landuse),
    size = 2,
    color = "black", show.legend = FALSE
  ) +
    geom_errorbar(
    data = three_way_cld,
    aes(y=emmean, ymin = lower.CL, ymax = upper.CL, x = landuse),
    width = 0,
    linewidth = 0.5, 
    color = "black", show.legend = FALSE
  ) +
  geom_text(data = three_way_cld, aes(x = landuse, y = upper.CL, label = .group), show.legend = FALSE) +
  facet_grid(litter_sp ~ mesh_size) +
  theme_bw(base_size = 20) +
  theme(legend.position="bottom") +
  scale_x_discrete(labels=c("Food forest", "Grassland")) +
  labs(y="Litter mass loss", x="Land use", fill="Landuse")
image
ggsave(file="LML_final.svg", width=12, height=10)
```

# Supplement

# PCA

``` {r PCA }
#pca with earthworms + micro-arthropods
mt_4_pca <- mt_4 %>% dplyr::select(c(landuse,location,loc_lu,ph_kcl,moisture_percentage,som_percentage,
                                     b.d.,ec,Total_P_mg_kg,Olsen_P_mg_kg,
                                     C_total,N_total,
                                     AMF_NLFA,
                                     Mites_oribatid_kg,Mites_oribatid_kg,Mites_other_kg,
                                     Springtails_nr_kg,earthworms_2022,biomass_ew_total))

colSums(is.na(mt_4_pca))
mt_4_pca_nomiss <- na.omit(mt_4_pca) # 3 plots only for which there is earthworm and arthropod data
colSums(is.na(mt_4_pca_nomiss))

mt_4_pca_done <- mt_4_pca_nomiss %>% dplyr::select(!c(landuse,location,loc_lu))

pca <- prcomp(mt_4_pca_done, scale=TRUE)
# fviz_eig(pca) #check scree plot

# fviz_pca_ind(pca,
#              col.ind = "cos2", # Color by the quality of representation
#              gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
#              repel = TRUE,     # Avoid text overlapping
#              mean.point = FALSE # Remove mean point
#              )

# fviz_pca_ind(pca, label="none", habillage=mt_4_pca_nomiss$location,
#             addEllipses=TRUE, ellipse.level=0.95, mean.point = FALSE)

fviz_pca_biplot(pca, label="var", palette = "Paired", 
                pointshape=21, fill.ind = mt_4_pca_nomiss$loc_lu, 
                col.ind = "black",
                pointsize=4, mean.point = FALSE, col.var = "#767676",
                legend.title="Locations and land uses", 
                repel=TRUE, title="")+ 
                xlim(-4,4) + ylim(-4,4) +
                theme(legend.position="bottom",
                      text = element_text(size = 14)) +
                guides(fill=guide_legend(title.position="top", 
                                     title.hjust =0.5)) + 
                xlab("PC1 (39.0%)") +
                ylab("PC2 (21.4%)")


ggsave("pca_small.png", width=8, height=8)
ggsave("pca_small_.svg")

``` 

``` {r PCA 2}

# PCA without earthworms + micro-arthropods

mt_4_pca_big <- mt_4 %>% dplyr::select(c(ph_kcl,moisture_percentage,som_percentage, b.d.,ec,
                                     Total_P_mg_kg,Olsen_P_mg_kg,C_total,N_total,bact_total,Fungi_total,AMF_NLFA
                                     ))
colSums(is.na(mt_4_pca_big))


pca_2 <- prcomp(mt_4_pca_big, scale=TRUE)
# fviz_pca_ind(pca_2,
#              col.ind = "cos2", # Color by the quality of representation
#              gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
#              repel = TRUE     # Avoid text overlapping
#              )

# fviz_pca_ind(pca_2, label="none", habillage=mt_4$loc_lu,
#              addEllipses=TRUE, ellipse.level=0.95, , palette = "Paired", pointshape=16, mean.point = FALSE)
# 
# fviz_pca_ind(pca_2, label="none", habillage=mt_4$loc_lu, palette = "Paired", pointshape=16, 
#              mean.point = FALSE)

fviz_pca_biplot(pca_2, label="var", palette = "Paired",
                pointshape=21, fill.ind = mt_4$loc_lu, 
                col.ind = "black",
                pointsize=4, mean.point = FALSE, col.var = "#767676",
                legend.title="Locations and land uses", 
                repel=TRUE, title="") + 
                xlim(-4,4) + ylim(-4,4) +
                theme(legend.position="bottom",
                      text = element_text(size = 14)) +
                guides(fill=guide_legend(title.position="top", 
                                     title.hjust =0.5)) + 
                xlab("PC1 (55.2%)") +
                ylab("PC2 (24.5%)")

ggsave("pca_big.png", width=8, height=8)
ggsave("pca_big.svg")

ind <- get_pca_ind(pca_2)

# ind$coord
``` 

# PERMANOVA

``` {r adonis}
char_dist <- vegdist(mt_4_pca_done, method="bray")

char_div <- adonis2(char_dist ~ location*landuse, data=mt_4_pca_nomiss, permutations = 999, method="bray", by="terms")

char_div

char_tab <- tidy(char_div) %>% flextable()
char_tab

```

