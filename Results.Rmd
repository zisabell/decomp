---
title: "Results"
author: "Isabelle van der Zanden and Gelieke Steeghs"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, echo = FALSE, warning = FALSE)
```

``` {r package}

library(tidyverse)
library(kableExtra)
library(flextable)
library(ggpubr)
library(rstatix)
library(readxl)
library(writexl)
library(lme4)
library(wesanderson)
library(multcomp)
library(multcompView)
library(emmeans)

```

``` {r upload and mutate files}
lml <- read_csv2("MASTER_LML.csv")

lml$litter_sp <- factor(lml$litter_sp, levels=c("Alder","Hazel","Chestnut"))
lml$mesh_size <- factor(lml$mesh_size, levels=c("Fine","Medium","Coarse"))

mt <- read_csv2("MASTERFILE_decomp_10.csv")

mt_2 <- mt %>% mutate(age = 2021-year_of_landuse,
                      earthworms_2021 = compost_worms + soil_eating_worms + pendelaars)

mt_2 <- mt_2 %>% rowwise() %>% mutate(earthworms_2022 = sum(c_across(contains("Abundance"))))
mt_2 <- mt_2 %>% rename("vb_code" = "code")

mt_2_lu <- mt_2 %>% select(vb_code, landuse)

# filter out only the 4 subplots that have been used for the litter mass experiment
mt_3 <- mt_2 %>% filter(plot_nr < 5)

# join litter mass data with landuse data

lml_2 <- lml %>% left_join(mt_2_lu, by ="vb_code")

```

# Results

``` {r table}

# add columns with sum of mites and earthworms biomass

mt_4 <- cbind(mt_3, mites_sum = rowSums(mt_3[c('Mites_oribatid_kg','Mites_other_kg')]))
mt_4 <- cbind(mt_4, biomass_ew_total = rowSums(mt_3[c('Biomass_anecic','Biomass_endogeic','Biomass_epigeic','Biomass_juvenile')]))

mt_wide <- mt_4 %>% pivot_longer(cols=c(ph_kcl:Olsen_P_mg_kg,Bacteria_total:Springtails_nr_kg,
                                        earthworms_2022,biomass_ew_total), names_to="measurement")

# check which columns to keep in table! maybe just sum # of earthworms or sum of biomass. maybe also sum of mites?

# set_flextable_defaults(
#   font.size = 12, font.family = "Open Sans",
#   font.color = "#333333",
#   table.layout = "fixed",
#   border.color = "gray",
#   padding.top = 3, padding.bottom = 3,
#   padding.left = 4, padding.right = 4)

# create custom order for parameters in the table

tab_order <- c('ph_kcl','som_percentage','b.d.','moisture_percentage','NO2_NO3_mg_kg','NH4_mg_kg','Total_P_mg_kg',
               'Olsen_P_mg_kg','earthworms_2022','biomass_ew_total','Springtails_nr_kg','Mites_oribatid_kg',
               'Mites_other_kg','nr_nematodes_gr_dry',
               'Bacteria_total','Microbial','Actinobacteria_total','Fungi_total','Total_plfa','AMF_NLFA')

tab <- mt_wide %>% group_by(landuse, measurement) %>% 
  summarise(mean = sprintf("%1.2f", mean(value, na.rm = TRUE)),
            sd = sprintf("(%1.2f)", sd(value, na.rm = TRUE))) %>% 
  unite("value",mean, sd, sep=" ") %>% 
  arrange(factor(measurement, levels = tab_order)) %>%
  pivot_wider(names_from=landuse, values_from=value) 

# tab above needs to be reordered before making flextable

tab %>% 
  flextable() %>% 
  labelizor(labels = c(measurement = "Measurements", Food_forest = "Food forest", 
                       NH4_mg_kg = "Ammonium (mg/kg)", NO2_NO3_mg_kg = "Nitrite and Nitrate (mg/kg)",
                       Total_P_mg_kg = "Total fosfor (mg/kg)", b.d. = "Bulk density (g/cm3)",
                       ph_kcl = "pH-KCl", soil_moisture = "Soil moisture (%)", 
                       som_percentage = "Soil organic matter (%)", earthworms_2022 = "Earthworms abundance",
                       biomass_ew_total = "Earthworms biomass",
                       Springtails_nr_kg = "Springtails abundance", Mites_oribatid_kg = "Mites oribatid abundance",
                       Mites_other_kg = "Mites other abundance", nr_nematodes_gr_dry = "Nematodes",
                       Bacteria_total = "Bacteria, total", Microbial = "Microbial",
                       Actinobacteria_total = "Actinobacteria, total", Fungi_total = "Fungi, total",
                       Total_plfa = "PFLA, total", AMF_NLFA = "AMF NFLA")) %>%
  set_table_properties(layout = "autofit")

# labels need to be completed for all measurements included in table (add units and such)

```
## Earthworm biomass functional groups

``` {r plot, stacked bar earthworm functional groups, fig.dim = c(10,8)}

mt_ew_long_b <- mt_2 %>% pivot_longer(cols=c(Biomass_anecic, Biomass_endogeic, Biomass_epigeic, Biomass_juvenile),
                                    names_to="Groups",values_to="biomass")

mt_ew_long_b$location <- factor(mt_ew_long_b$location, levels = c("Haarzuilens", "Vlaardingen","Boelenslaan", "Amsterdam"),
                                labels = c("Location 1", "Location 2", "Location 3", "Location 4"))

mt_ew_long_b %>% 
  group_by(location, landuse, Groups) %>%
  summarize(average = mean(biomass, na.rm=TRUE), .groups="drop") %>%
  ggplot(aes(x=landuse, y=average, fill=Groups)) + 
  geom_col(width=0.6) +
  scale_fill_manual(values=wes_palette("Cavalcanti1"), labels=c("Anecic earthworms",
                                                                   "Endogeic earthworms",
                                                                   "Epigeic earthworms",
                                                                   "Juveniles")) +
  facet_grid(~location) +
  theme_bw(base_size = 18) +
  theme(legend.position="bottom") +
  scale_x_discrete(labels=c("Food forest", "Grassland")) +
  labs(x="Landuse", y="Average earthworm biomass per plot (gr)",  fill="Microbial groups")

```

## PLFA/NLFA biomass microbial groups

``` {r plot, stacked bar microbial groups, fig.dim = c(10,8)}

mt_plfa_long <- mt_2 %>% pivot_longer(cols=c(Bacteria_total, Actinobacteria_total, Fungi_total, AMF_NLFA),
                                      names_to="Groups",values_to="concentration")

mt_plfa_long$location <- factor(mt_plfa_long$location, levels = c("Haarzuilens", "Vlaardingen","Boelenslaan", "Amsterdam"),
                  labels = c("Location 1", "Location 2", "Location 3", "Location 4"))

mt_plfa_long %>% 
  group_by(location,landuse, Groups) %>%
  summarize(average = mean(concentration), .groups="drop") %>%
  ggplot(aes(x=landuse, y=average, fill=Groups)) + 
  geom_col(width=0.6) +
  scale_fill_manual(values=wes_palette("Cavalcanti1"), labels=c("Actinobacteria",
                                                                "AMF",
                                                                "Bacteria",
                                                                "Fungi")) +
  facet_grid(~location)  +
  theme_bw(base_size = 18) +
  theme(legend.position="bottom") +
  scale_x_discrete(labels=c("Food forest", "Grassland")) +
  labs(x="Landuse", y="Average estimation microbial biomass (ug/gr of soil)",  fill="Microbial groups")

```

## Litter mass loss

``` {r plot, boxplot litter mass loss, fig.dim = c(8,10)}

lml_2 %>% group_by(mesh_size, litter_sp) %>%
  ggplot(aes(x=landuse, y=litter_mass_loss_final, fill=landuse)) +
  geom_boxplot(outlier.shape = NA, alpha=0.8, show.legend = FALSE) +
  scale_fill_manual(values=wes_palette("Royal1"), labels=c("Food forest","Grassland")) + 
  geom_point(position = position_jitterdodge(0.4), 
             pch=16, color="black",
             show.legend = FALSE) +
  facet_grid(mesh_size ~ litter_sp) +
  theme_bw(base_size = 16) +
  scale_x_discrete(labels=c("Food forest", "Grassland")) +
  labs(y="Litter mass loss (%)", x="Landuse", fill="Landuse")


``` 
