---
title: "Results"
author: "Isabelle van der Zanden and Gelieke Steeghs"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, echo = FALSE, warning = FALSE)
```

``` {r package}

library(Rmisc)
library(tidyverse)
library(kableExtra)
library(flextable)
library(ggpubr)
library(rstatix)
library(readxl)
library(writexl)
library(car)
library(lme4)
library(wesanderson)
library(multcomp)
library(multcompView)
library(emmeans)
library(broom)
library(broom.mixed)
library(ggcorrplot)
library(reshape2)

```

``` {r upload and mutate files}
lml <- read_csv2("MASTER_LML.csv")

lml$litter_sp <- factor(lml$litter_sp, levels=c("Alder","Hazel","Chestnut"))
lml$mesh_size <- factor(lml$mesh_size, levels=c("Fine","Medium","Coarse"))

mt <- read_csv2("MASTERFILE_decomp_10.csv")

mt_2 <- mt %>% mutate(age = 2021-year_of_landuse,
                      earthworms_2021 = compost_worms + soil_eating_worms + pendelaars)

mt_2 <- mt_2 %>% rowwise() %>% dplyr::mutate(earthworms_2022 = sum(dplyr::c_across(contains("Abundance"))))
mt_2 <- mt_2 %>% dplyr::rename("vb_code" = "code")

mt_2_lu_loc <- mt_2 %>% dplyr::select(vb_code, landuse, location)

# filter out only the 4 subplots that have been used for the litter mass experiment
mt_3 <- mt_2 %>% filter(plot_nr < 5)

# join litter mass data with landuse & location data

lml_2 <- lml %>% left_join(mt_2_lu_loc, by ="vb_code")

# sum columns mites and earthworms
mt_4 <- cbind(mt_3, mites_sum = rowSums(mt_3[c('Mites_oribatid_kg','Mites_other_kg')]))
mt_4 <- cbind(mt_4, biomass_ew_total = rowSums(mt_3[c('Biomass_anecic','Biomass_endogeic','Biomass_epigeic','Biomass_juvenile')]))

```

# Results

Average AMF biomass in grassland was `r format(mt_4 %>% filter(landuse == "Grassland") %>% summarize(mean = mean(AMF_NLFA, na.rm=TRUE)), digits=2)` ug/gr. (example)

``` {r table}

# set_flextable_defaults(
#   font.size = 12, font.family = "Open Sans",
#   font.color = "#333333",
#   table.layout = "fixed",
#   border.color = "gray",
#   padding.top = 3, padding.bottom = 3,
#   padding.left = 4, padding.right = 4)

# # run ANOVA for ph_kcl as a test
# mt_4.lmeFit <- lmer(ph_kcl ~ landuse + (1|location),data=mt_4, na.action = "na.omit")
# anova(mt_4.lmeFit)
# 
# cld(lsmeans(mt_4.lmeFit,~ landuse,adjust="tukey"), Letters = c(letters))

# list of model outputs ANOVA
models <- list()
for (i in c('ph_kcl','som_percentage','b.d.','moisture_percentage','NO2_NO3_mg_kg','NH4_mg_kg',
            'Total_P_mg_kg','Olsen_P_mg_kg','earthworms_2022','biomass_ew_total',
            'Springtails_nr_kg','Mites_oribatid_kg','Mites_other_kg','nr_nematodes_gr_dry',
            'Bacteria_total','Microbial','Actinobacteria_total','Fungi_total','Total_plfa','AMF_NLFA')) {
  f <- formula(paste(i,"~ landuse + (1|location)"))
  models[[i]] <- lmer(f, data=mt_4, na.action = "na.omit")
}

cld(lsmeans(models$AMF_NLFA,~ landuse, adjust="tukey"), Letters = c(letters))

tab_order <- c('ph_kcl','som_percentage','b.d.','moisture_percentage','NO2_NO3_mg_kg','NH4_mg_kg','Total_P_mg_kg',
               'Olsen_P_mg_kg','earthworms_2022','biomass_ew_total','Springtails_nr_kg','Mites_oribatid_kg',
               'Mites_other_kg','nr_nematodes_gr_dry',
               'Bacteria_total','Microbial','Actinobacteria_total','Fungi_total','Total_plfa','AMF_NLFA')

mt_wide <- mt_4 %>% pivot_longer(cols=c(ph_kcl:Olsen_P_mg_kg,Bacteria_total:Springtails_nr_kg,
                                        earthworms_2022,biomass_ew_total), names_to="measurement")

tab <- mt_wide %>% group_by(landuse, measurement) %>% 
  summarise(mean = sprintf("%1.2f", mean(value, na.rm = TRUE)),
            sd = sprintf("(%1.2f)", sd(value, na.rm = TRUE))) %>% 
  unite("value",mean, sd, sep=" ") %>% 
  arrange(factor(measurement, levels = tab_order)) %>%
  pivot_wider(names_from=landuse, values_from=value) 

tab %>% 
  flextable() %>% 
  labelizor(labels = c(measurement = "Measurements", Food_forest = "Food forest", 
                       NH4_mg_kg = "Ammonium (mg/kg)", NO2_NO3_mg_kg = "Nitrite and Nitrate (mg/kg)",
                       Total_P_mg_kg = "Total fosfor (mg/kg)", b.d. = "Bulk density (g/cm3)",
                       ph_kcl = "pH-KCl", soil_moisture = "Soil moisture (%)", 
                       som_percentage = "Soil organic matter (%)", earthworms_2022 = "Earthworms abundance",
                       biomass_ew_total = "Earthworms biomass",
                       Springtails_nr_kg = "Springtails abundance", Mites_oribatid_kg = "Mites oribatid abundance",
                       Mites_other_kg = "Mites other abundance", nr_nematodes_gr_dry = "Nematodes",
                       Bacteria_total = "Bacteria, total", Microbial = "Microbial",
                       Actinobacteria_total = "Actinobacteria, total", Fungi_total = "Fungi, total",
                       Total_plfa = "PFLA, total", AMF_NLFA = "AMF NFLA")) %>%
  set_table_properties(layout = "autofit")

# labels need to be completed for all measurements included in table (add units and such)

```

# Statistics

## Litter mass loss data - Litter species x mesh size x land use

``` {r statistics litter mass loss, fig.dim = c(10,8)}

# Descriptive statistics
summarySE (lml_2, measurevar="litter_mass_loss_final", na.rm=TRUE)
summarySE (lml_2, measurevar="litter_mass_loss_final", groupvars=c("landuse"), na.rm=TRUE)

# Levene's test for homogeneity of variances
variances_lml_lu_loc <- leveneTest(litter_mass_loss_final ~ landuse * location, data = lml_2)
variances_lml_lu_loc

# variances_lml_lu <- leveneTest(litter_mass_loss_final ~ landuse, data = lml_2)
# variances_lml_lu

# Histogram of the raw data
gghistogram(lml_2, x='litter_mass_loss_final', fill = 'lightgrey', na.rm=TRUE)

# Three-way ANOVA
threeway.lmeFit <- lmer(litter_mass_loss_final ~ landuse * litter_sp * mesh_size + (1|location/landuse/vb_code),data=lml_2, 
                      na.action = "na.omit")
summary(threeway.lmeFit)
anova(threeway.lmeFit)
# Three-way interaction letters are there but it looks kind of messy (probably better to do it manually again)
threeway_cld <- cld(lsmeans(threeway.lmeFit,~ landuse * litter_sp * mesh_size,adjust="tukey"), Letters = c(letters))

# Three-way ANOVA, different function that includes p-value in the output (but also different output compared to the other anova function)
threeway_aov <- aov(litter_mass_loss_final ~ landuse * litter_sp * mesh_size + (1:location/landuse/vb_code), data=lml_2, na.action = "na.omit")
summary(threeway_aov)

# Testing the residuals
ggqqplot(residuals(threeway.lmeFit))
shapiro.test(residuals(threeway.lmeFit)) # it is significant...

# Arcsine transformation (does not seem to make any difference)
lml_3 <- lml_2
lml_3$litter_mass_loss_final <- asin(sqrt(lml_2$litter_mass_loss_final))
threeway_3.lmeFit <- lmer(litter_mass_loss_final ~ landuse * litter_sp * mesh_size + (1|location/landuse),data=lml_3, 
                      na.action = "na.omit")
ggqqplot(residuals(threeway_3.lmeFit))
shapiro.test(residuals(threeway_3.lmeFit))

# Plot the outcomes
image <- lml_2 %>% group_by(mesh_size, litter_sp) %>%
  ggplot(aes(x=landuse, y=litter_mass_loss_final, fill=landuse)) +
  geom_boxplot(outlier.shape = NA, alpha=0.8, show.legend = FALSE) +
  scale_fill_manual(values=wes_palette("Royal1"), labels=c("Food forest","Grassland")) + 
  geom_point(position = position_jitterdodge(0.4), 
             pch=16, color="black",show.legend = FALSE) +
  #geom_text(data = threeway_cld, aes(x = landuse, y = upper.CL, label = .group))
  scale_fill_manual(values=c("#549E39","#ffa600")) +
  facet_grid(mesh_size ~ litter_sp) +
  theme_bw(base_size = 16) +
  scale_x_discrete(labels=c("Food forest", "Grassland")) +
  labs(y="Litter mass loss (%)", x="Land use", fill="Landuse")

image

ggsave(file="3x3plot.svg", plot=image, width=10, height=10)

``` 

## Litter mass loss data - Litter species x mesh size

```{r statistics litterxmesh}

# Two-way ANOVAs (for significance letters)
## Litter species x Mesh size
litter_mesh.lmeFit <- lmer(litter_mass_loss_final ~ litter_sp * mesh_size + (1|location/landuse/vb_code),data=lml_2,
                      na.action = "na.omit")
anova(litter_mesh.lmeFit)
cld(lsmeans(litter_mesh.lmeFit,~ litter_sp * mesh_size, adjust="tukey"), Letters = c(letters))

# Testing the residuals
ggqqplot(residuals(litter_mesh.lmeFit))
shapiro.test(residuals(litter_mesh.lmeFit))
```

## Litter mass loss data - Alder (Mesh size x Land use)

```{r statistics alder}
# Two-way ANOVAs (for significance letters)
# Testing for each litter species individually. A lot of copy pasta spaghetti code, hope to make this more 
# streamlined still

#lml_2_litter.lmeFit <- lmer(litter_mass_loss_final ~ mesh_size * landuse + #(1|location/landuse/vb_code),data=lml_2_litter, 
 #                     na.action = "na.omit")
#anova(lml_2_litter.lmeFit)

lml_2_alder <- lml_2 %>%
  dplyr::filter(litter_sp == "Alder")
alder.lmeFit <- lmer(litter_mass_loss_final ~ mesh_size * landuse + (1|location/landuse/vb_code),data=lml_2_alder, 
                      na.action = "na.omit")
anova(alder.lmeFit)
cld(lsmeans(alder.lmeFit,~ mesh_size * landuse, adjust="tukey"), Letters = c(letters))

# Descriptive statistics
summarySE (lml_2_alder, measurevar="litter_mass_loss_final", na.rm=TRUE)
summarySE (lml_2_alder, measurevar="litter_mass_loss_final", groupvars=c("landuse"), na.rm=TRUE)

# Levene's test for homogeneity of variances
variances_lml_lu_loc <- leveneTest(litter_mass_loss_final ~ landuse * location, data = lml_2_alder)
variances_lml_lu_loc

# Histogram of the raw data
gghistogram(lml_2_alder, x='litter_mass_loss_final', fill = 'lightgrey', na.rm=TRUE)

# Residuals
ggqqplot(residuals(alder.lmeFit))
shapiro.test(residuals(alder.lmeFit))
```

## Litter mass loss data - Hazel (Mesh size x Land use)

```{r statistics hazel}

lml_2_hazel <- lml_2 %>%
  dplyr::filter(litter_sp == "Hazel")
hazel.lmeFit <- lmer(litter_mass_loss_final ~ mesh_size * landuse + (1|location/landuse/vb_code),data=lml_2_hazel, 
                      na.action = "na.omit")
anova(hazel.lmeFit)
cld(lsmeans(hazel.lmeFit,~ mesh_size * landuse, adjust="tukey"), Letters = c(letters))

# Descriptive statistics
summarySE (lml_2_hazel, measurevar="litter_mass_loss_final", na.rm=TRUE)
summarySE (lml_2_hazel, measurevar="litter_mass_loss_final", groupvars=c("landuse"), na.rm=TRUE)

# Levene's test for homogeneity of variances
variances_lml_lu_loc <- leveneTest(litter_mass_loss_final ~ landuse * location, data = lml_2_hazel)
variances_lml_lu_loc

# Histogram of the raw data
gghistogram(lml_2_hazel, x='litter_mass_loss_final', fill = 'lightgrey', na.rm=TRUE)

# Residuals
ggqqplot(residuals(hazel.lmeFit))
shapiro.test(residuals(hazel.lmeFit))

```

## Litter mass loss data - Chestnut (Mesh size x Land use)

```{r statistics chestnut}

lml_2_chestnut <- lml_2 %>%
  dplyr::filter(litter_sp == "Chestnut")
chestnut.lmeFit <- lmer(litter_mass_loss_final ~ mesh_size * landuse + (1|location/landuse/vb_code),data=lml_2_chestnut, na.action = "na.omit")
anova(chestnut.lmeFit)
cld(lsmeans(chestnut.lmeFit,~ mesh_size * landuse, adjust="tukey"), Letters = c(letters))

# Descriptive statistics
summarySE (lml_2_chestnut, measurevar="litter_mass_loss_final", na.rm=TRUE)
summarySE (lml_2_chestnut, measurevar="litter_mass_loss_final", groupvars=c("landuse"), na.rm=TRUE)

# Levene's test for homogeneity of variances
variances_lml_lu_loc <- leveneTest(litter_mass_loss_final ~ landuse * location, data = lml_2_chestnut)
variances_lml_lu_loc

# Histogram of the raw data
gghistogram(lml_2_chestnut, x='litter_mass_loss_final', fill = 'lightgrey', na.rm=TRUE)

# Residuals
ggqqplot(residuals(chestnut.lmeFit))
shapiro.test(residuals(chestnut.lmeFit))

```


## Earthworm biomass functional groups

This figure will not be part of the result section, just for our interpretation

``` {r plot, stacked bar earthworm functional groups, fig.dim = c(10,8)}

mt_ew_long_b <- mt_2 %>% pivot_longer(cols=c(Biomass_anecic, Biomass_endogeic, Biomass_epigeic, Biomass_juvenile),
                                    names_to="Groups",values_to="biomass")

mt_ew_long_b$location <- factor(mt_ew_long_b$location, levels = c("Haarzuilens", "Vlaardingen","Boelenslaan", "Amsterdam"),
                                labels = c("Location 1", "Location 2", "Location 3", "Location 4"))

mt_ew_long_b %>% 
  group_by(location, landuse, Groups) %>%
  summarize(average = mean(biomass, na.rm=TRUE), .groups="drop") %>%
  ggplot(aes(x=landuse, y=average, fill=Groups)) + 
  geom_col(width=0.6) +
  scale_fill_manual(values=wes_palette("Cavalcanti1"), labels=c("Anecic earthworms",
                                                                   "Endogeic earthworms",
                                                                   "Epigeic earthworms",
                                                                   "Juveniles")) +
  facet_grid(~location) +
  theme_bw(base_size = 18) +
  theme(legend.position="bottom") +
  scale_x_discrete(labels=c("Food forest", "Grassland")) +
  labs(x="Landuse", y="Average earthworm biomass per plot (gr)",  fill="Microbial groups")

```

## PLFA/NLFA biomass microbial groups

This figure will not be part of the result section, just for our interpretation

``` {r plot, stacked bar microbial groups, fig.dim = c(10,8)}

mt_plfa_long <- mt_2 %>% pivot_longer(cols=c(Bacteria_total, Actinobacteria_total, Fungi_total, AMF_NLFA),
                                      names_to="Groups",values_to="concentration")

mt_plfa_long$location <- factor(mt_plfa_long$location, levels = c("Haarzuilens", "Vlaardingen","Boelenslaan", "Amsterdam"),
                  labels = c("Location 1", "Location 2", "Location 3", "Location 4"))

mt_plfa_long %>% 
  group_by(location,landuse, Groups) %>%
  summarize(average = mean(concentration), .groups="drop") %>%
  ggplot(aes(x=landuse, y=average, fill=Groups)) + 
  geom_col(width=0.6) +
  scale_fill_manual(values=wes_palette("Cavalcanti1"), labels=c("Actinobacteria",
                                                                "AMF",
                                                                "Bacteria",
                                                                "Fungi")) +
  facet_grid(~location)  +
  theme_bw(base_size = 18) +
  theme(legend.position="bottom") +
  scale_x_discrete(labels=c("Food forest", "Grassland")) +
  labs(x="Landuse", y="Average estimation microbial biomass (ug/gr of soil)",  fill="Microbial groups")

# Run ANOVAs to test for the effect of land use vs location -> need to make figures out of this
# AMF_NLFA is the only one significant for land use
mt_2.lmeFit <- lmer(AMF_NLFA ~ landuse + (1|location),data=mt_2, na.action = "na.omit")
anova(mt_2.lmeFit)
cld(lsmeans(mt_2.lmeFit,~ landuse,adjust="tukey"), Letters = c(letters))
# Bacteria_total is the only one significant for location
mt_2.lmeFit <- lmer(Bacteria_total ~ location + (1|location),data=mt_2, na.action = "na.omit")
anova(mt_2.lmeFit)
cld(lsmeans(mt_2.lmeFit,~ location,adjust="tukey"), Letters = c(letters))


```


## Correlation matrix variables  

```{r correlation matrix, fig.dim=c(12,12)}
corr <- round(cor(mt_4 %>% dplyr::select(c('ph_kcl','som_percentage','b.d.','moisture_percentage',
                                           'NO2_NO3_mg_kg','NH4_mg_kg',
            'Total_P_mg_kg','Olsen_P_mg_kg','earthworms_2022','biomass_ew_total',
            'Springtails_nr_kg','Mites_oribatid_kg','Mites_other_kg','nr_nematodes_gr_dry',
            'Bacteria_total','Microbial','Actinobacteria_total','Fungi_total','Total_plfa','AMF_NLFA')),
            use='pairwise.complete.obs'), 1)

# automatic ggcorrplot
# ggcorrplot(corr, method = "circle")

# more adjustable ggplot version
ggplot(melt(corr), aes(Var1, Var2, fill=value)) +
  geom_tile(height=0.8, width=0.8) +
  scale_fill_gradient2(low="blue", mid="white", high="red") +
  theme_minimal() +
  coord_equal() +
  labs(x="",y="",fill="Corr") +
  theme(axis.text.x=element_text(size=18, angle=45, vjust=1, hjust=1, 
                                 margin=margin(-3,0,0,0)),
        axis.text.y=element_text(size=18, margin=margin(0,-3,0,0)),
        panel.grid.major=element_blank()) 
``` 