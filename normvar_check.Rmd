---
title: "normvar_check"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, echo = FALSE, warning = FALSE)
```

``` {r package}
library(tidyverse)
library(ggpubr)
library(car)
library(gridExtra)
library(flextable)
library(lmerTest)
# library(lme4)
library(multcomp)
library(emmeans)
library(broom.mixed)
library(nlme)

```

``` {r upload and mutate files}
lml <- read_csv2("MASTER_LML.csv")

lml$litter_sp <- factor(lml$litter_sp, levels=c("Alder","Hazel","Chestnut"))
lml$mesh_size <- factor(lml$mesh_size, levels=c("Fine","Medium","Coarse"))

mt <- read_csv2("MASTERFILE_decomp_10.csv")

mt_2 <- mt %>% mutate(age = 2021-year_of_landuse,
                      earthworms_2021 = compost_worms + soil_eating_worms + pendelaars)

mt_2 <- mt_2 %>% rowwise() %>% mutate(earthworms_2022 = sum(c_across(contains("Abundance"))))
mt_2 <- mt_2 %>% rename("vb_code" = "code")

# join litter mass data with landuse & location data
mt_2_lu_loc <- mt_2 %>% dplyr::select(vb_code, landuse, location)
lml_2 <- lml %>% left_join(mt_2_lu_loc, by ="vb_code")

# mt_3 <- mt_2 %>% filter(plot_nr < 5)

# sum columns mites and earthworms
mt_4 <- cbind(mt_2, mites_sum = rowSums(mt_2[c('Mites_oribatid_kg','Mites_other_kg')]))
mt_4 <- cbind(mt_4, biomass_ew_total = 
                rowSums(mt_2[c('Biomass_anecic','Biomass_endogeic','Biomass_epigeic','Biomass_juvenile')]))

```
## normality and variances

``` {R data check, fig.dim=c(12, 18)}
# variables

vars <- mt_4 %>%
  dplyr::select(ph_kcl, som_percentage, b.d., moisture_percentage, NO2_NO3_mg_kg, NH4_mg_kg,
            Total_P_mg_kg, Olsen_P_mg_kg, earthworms_2022, biomass_ew_total,
            Springtails_nr_kg, Mites_oribatid_kg, Mites_other_kg, nr_nematodes_gr_dry,
            Bacteria_total, Microbial, Actinobacteria_total, Fungi_total, Total_plfa, AMF_NLFA) %>%
  names() %>%
  set_names()

# normality and equal variances

normality <- map(vars, ~gghistogram(mt_4, .x,  fill = 'lightgrey', na.rm=TRUE))
plots_list <- map(normality, ~.x)
# grid.arrange(grobs = plots_list, ncol = 2, nrow = 10)

variances_loc_lu <- map(vars, ~leveneTest(mt_4[[.x]] ~ landuse * location, data = mt_4))

# tab_var <- mt_4 %>% group_by(landuse, location) %>% 
#   dplyr::select(ph_kcl, som_percentage, b.d.,                                                
#                 moisture_percentage, 
#                 NO2_NO3_mg_kg, NH4_mg_kg, Total_P_mg_kg, Olsen_P_mg_kg, earthworms_2022, 
#                 biomass_ew_total, Springtails_nr_kg, Mites_oribatid_kg, Mites_other_kg, 
#                 nr_nematodes_gr_dry,Bacteria_total, Microbial, Actinobacteria_total, 
#                 Fungi_total, Total_plfa, AMF_NLFA) %>% 
#           summarize_all(var, na.rm=TRUE) %>% mutate(across(where(is.numeric), round, 1))
# 
# tab_var %>% pivot_longer(cols=c(ph_kcl:AMF_NLFA)) %>% 
#                   pivot_wider(names_from = c(landuse,location),values_from = value) %>%
#             flextable()  %>%
#             set_table_properties(layout = "autofit")


``` 

``` {r nested ANOVA all variables}
# list of model outputs ANOVA
models <- list()
for (i in c('ph_kcl','som_percentage','b.d.','moisture_percentage','NO2_NO3_mg_kg','NH4_mg_kg',
            'Total_P_mg_kg','Olsen_P_mg_kg','earthworms_2022','biomass_ew_total',
            'Springtails_nr_kg','Mites_oribatid_kg','Mites_other_kg','nr_nematodes_gr_dry',
            'Bacteria_total','Microbial','Actinobacteria_total','Fungi_total','Total_plfa','AMF_NLFA')) {
  f <- formula(paste(i,"~ landuse + (1|location)"))
  models[[i]] <- lmerTest::lmer(f, data=mt_4, na.action = "na.omit")
}
``` 

### pH

``` {R data check pH, fig.dim=c(3,5)}
mt_4 %>% group_by(landuse, location) %>% summarize(mean=mean(ph_kcl),sd=sd(ph_kcl),var=var(ph_kcl))
variances_loc_lu$ph_kcl
# normality$ph_kcl
mt_4 %>% group_by(landuse) %>% ggplot(aes(x=landuse, y=ph_kcl, color=landuse)) + geom_boxplot() + theme(legend.position='none')
# par(mfrow=c(1,2))
# plot(fitted(models$ph_kcl, res))
qqPlot(residuals(models$ph_kcl))
shapiro.test(residuals(models$ph_kcl))
anova(models$ph_kcl)
# ranef(models$ph_kcl) # calls random effects estimates

# # transformed data pH <<<<< more not-normally distributed residuals!!
# gghistogram(exp(-mt_4$ph_kcl),  fill = 'lightgrey', na.rm=TRUE, binwidth = 0.0003)
# ph_transf <- lmer(exp(-ph_kcl) ~ landuse + (1|location), data=mt_4, na.action = "na.omit")
# anova(ph_transf)
# summary(ph_transf)
# cld(lsmeans(ph_transf,~ landuse,adjust="tukey"), Letters = c(letters))
# shapiro.test(residuals(ph_transf))
# qqPlot(residuals(ph_transf))

```
**pH conclusion:**  
Equal variance, shapiro wilk shows non-normal distributed residuals (p=`r round(shapiro.test(residuals(models$ph_kcl))$p.value, digits=2)`). Detransformation of pH (exp(-pH)) didn't improve normality of residuals. QQ-plot residuals looks fine. Conclusion: use non-transformed data in linear mixed model.  
- p-value = `r tidy(models$ph_kcl)$p.value[2]`  
- t-value = `r tidy(models$ph_kcl)$statistic[2]`  
- F-value = `r tidy(models$ph_kcl)$statistic[2]^2`  

### SOM

``` {R data check som, fig.dim=c(3,5)}
mt_4 %>% group_by(landuse, location) %>% 
    summarize(mean=mean(som_percentage),sd=sd(som_percentage),var=var(som_percentage))
# variances_loc_lu$som_percentage
# normality$som_percentage
mt_4 %>% group_by(landuse) %>% ggplot(aes(x=landuse, y=som_percentage, color=landuse)) + geom_boxplot() + theme(legend.position='none')
# par(mfrow=c(1,2))
# plot(fitted(models$som_percentage, res))
qqPlot(residuals(models$som_percentage))
# cld(lsmeans(models$som_percentage,~ landuse, adjust="sidak"), Letters = c(letters))
# shapiro.test(residuals(models$som_percentage))
anova(models$som_percentage)
```

**som conclusion:**  
Equal variances, shapiro wilk shows normal residuals. Conclusion: use non-transformed data in linear mixed model.  
- p-value = `r tidy(models$som_percentage)$p.value[2]`  
- t-value = `r tidy(models$som_percentage)$statistic[2]`  
- F-value = `r tidy(models$som_percentage)$statistic[2]^2`  

### b.d.

``` {R data check b.d., fig.dim=c(3,5)}
mt_4 %>% group_by(landuse, location) %>% 
          summarize(mean=mean(b.d.),sd=sd(b.d.),var=var(b.d.))
# variances_loc_lu$b.d.
# par(mfrow=c(1,2))
# normality$b.d.
mt_4 %>% group_by(landuse) %>% ggplot(aes(x=landuse, y=b.d., color=landuse)) + geom_boxplot() + theme(legend.position='none')
# plot(fitted(models$b.d., res))
qqPlot(residuals(models$b.d.))
# cld(lsmeans(models$b.d.,~ landuse, adjust="tukey"), Letters = c(letters))
shapiro.test(residuals(models$b.d.))
anova(models$b.d.)
```

**bulk density conclusion:**  
Equal variances, non-normal residuals from shapiro-wilk (p=`r round(shapiro.test(residuals(models$b.d.))$p.value, digits=3)`), but QQ-plot looks fine. Conclusion: use non-transformed data in linear mixed model.  
- p-value = `r tidy(models$b.d.)$p.value[2]`  
- t-value = `r tidy(models$b.d.)$statistic[2]`  
- F-value = `r tidy(models$b.d.)$statistic[2]^2`  

### moisture_percentage

``` {R data check moisture_percentage, fig.dim=c(3,5)}
mt_4 %>% group_by(landuse, location) %>% 
  summarize(mean=mean(moisture_percentage),sd=sd(moisture_percentage),
            var=var(moisture_percentage))
# variances_loc_lu$moisture_percentage
# par(mfrow=c(1,2))
# normality$moisture_percentage
mt_4 %>% group_by(landuse) %>% ggplot(aes(x=landuse, y=moisture_percentage,
                                          color=landuse)) + geom_boxplot() + 
          theme(legend.position='none')
# plot(fitted(models$moisture_percentage, res))
qqPlot(residuals(models$moisture_percentage))
# shapiro.test(residuals(models$moisture_percentage))
anova(models$moisture_percentage)
```

**moisture percentage conclusion:**  
Equal variances, normal residuals from shapiro-wilk, QQ-plot looks good. Conclusion: use non-transformed data in linear mixed model.  
- p-value = `r tidy(models$moisture_percentage)$p.value[2]`  
- t-value = `r tidy(models$moisture_percentage)$statistic[2]`  
- F-value = `r tidy(models$moisture_percentage)$statistic[2]^2`  

### NO2_NO3_mg_kg

``` {R data check NO2_NO3_mg_kg, fig.dim=c(3,5)}
mt_4 %>% group_by(landuse, location) %>% 
  summarize(mean=mean(NO2_NO3_mg_kg),sd=sd(NO2_NO3_mg_kg),var=var(NO2_NO3_mg_kg))
variances_loc_lu$NO2_NO3_mg_kg
# par(mfrow=c(1,2))
# normality$NO2_NO3_mg_kg
mt_4 %>% group_by(landuse) %>% ggplot(aes(x=landuse, y=NO2_NO3_mg_kg, color=landuse)) + 
    geom_boxplot() + theme(legend.position='none')
# plot(fitted(models$NO2_NO3_mg_kg, res))
qqPlot(residuals(models$NO2_NO3_mg_kg))
# shapiro.test(residuals(models$NO2_NO3_mg_kg))
anova(models$NO2_NO3_mg_kg)

# Log transformation
var_log_N <- leveneTest(log(NO2_NO3_mg_kg) ~ landuse * location, data=mt_4) #UNEQUAL VARIANCES FIXED!
mod_log_N <- lmer(log(NO2_NO3_mg_kg+0.001) ~ landuse + (1|location), data=mt_4,
                  na.action = "na.omit")
qqPlot(residuals(mod_log_N))
```

**NO2 and NO3 conclusion:**   
Non-equal variances (p=`r round(variances_loc_lu$NO2_NO3_mg_kg$"Pr(>F)"[1], digits=3)`), non-normal residuals (p=`r round(shapiro.test(residuals(models$NO2_NO3_mg_kg))$p.value, digits=3)`) from shapiro-wilk. QQ-plot looks good though. 
Log transformation gives equal variances (p=`r round(var_log_N$"Pr(>F)"[1], digits=3)`) and normal shapiro test on residuals (p=`r round(shapiro.test(residuals(mod_log_N))$p.value, digits=3)`)

Conclusion: log transformation with linear mixed model??  
- p-value = `r tidy(mod_log_N)$p.value[2]`  
- t-value = `r tidy(mod_log_N)$statistic[2]`  
- F-value = `r tidy(mod_log_N)$statistic[2]^2`  

### NH4_mg_kg

``` {R data check NH4_mg_kg, fig.dim=c(3,5)}
mt_4 %>% group_by(landuse, location) %>% summarize(mean=mean(NH4_mg_kg),sd=sd(NH4_mg_kg),var=var(NH4_mg_kg))
# variances_loc_lu$NH4_mg_kg
# par(mfrow=c(1,2))
# normality$NH4_mg_kg
mt_4 %>% group_by(landuse) %>% ggplot(aes(x=landuse, y=NH4_mg_kg, color=landuse)) + geom_boxplot() + theme(legend.position='none')
# plot(fitted(models$NH4_mg_kg, res))
qqPlot(residuals(models$NH4_mg_kg))
shapiro.test(residuals(models$NH4_mg_kg))
anova(models$NH4_mg_kg)
```

**NH4 conclusion:**  
Equal variances, normal residuals shapiro-wilk, QQ-plot looks good. Conclusion: use non-transformed data in linear mixed model.  
- p-value = `r tidy(models$NH4_mg_kg)$p.value[2]`  
- t-value = `r tidy(models$NH4_mg_kg)$statistic[2]`  
- F-value = `r tidy(models$NH4_mg_kg)$statistic[2]^2`  

### Total_P_mg_kg

``` {R data check Total_P_mg_kg, fig.dim=c(3,5)}
mt_4 %>% group_by(landuse, location) %>% summarize(mean=mean(Total_P_mg_kg),sd=sd(Total_P_mg_kg),var=var(Total_P_mg_kg))
variances_loc_lu$Total_P_mg_kg
# par(mfrow=c(1,2))
# normality$Total_P_mg_kg
mt_4 %>% group_by(landuse) %>% ggplot(aes(x=landuse, y=Total_P_mg_kg, color=landuse)) + geom_boxplot() + theme(legend.position='none')
# plot(fitted(models$Total_P_mg_kg, res))
qqPlot(residuals(models$Total_P_mg_kg))
# cld(lsmeans(models$Total_P_mg_kg,~ landuse, adjust="tukey"), Letters = c(letters))
shapiro.test(residuals(models$Total_P_mg_kg))

# Log transformation FIXED!!
var_log_P <- leveneTest(log(Total_P_mg_kg) ~ landuse * location, data=mt_4)
mod_log_P <- lmer(log(Total_P_mg_kg+0.001) ~ landuse + (1|location), data=mt_4,
                  na.action = "na.omit")
qqPlot(residuals(mod_log_P))
shapiro.test(residuals(mod_log_P))
anova(mod_log_P)
```

**Total P conclusion**  
Non-equal variances (p=`r round(variances_loc_lu$Total_P_mg_kg$"Pr(>F)"[1], digits=3)`), non-normal residuals from shapiro-wilk (p=`r round(shapiro.test(residuals(models$Total_P_mg_kg))$p.value, digits=3)`). QQ-plot looks good.

Log transformation gives equal variances (p=`r round(var_log_P$"Pr(>F)"[1], digits=3)`) and normal shapiro test on residuals (p=`r round(shapiro.test(residuals(mod_log_P))$p.value, digits=3)`).

### Olsen_P_mg_kg

``` {R data check Olsen_P_mg_kg, fig.dim=c(3,5)}
mt_4 %>% group_by(landuse, location) %>% summarize(mean=mean(Olsen_P_mg_kg),sd=sd(Olsen_P_mg_kg),var=var(Olsen_P_mg_kg))
# variances_loc_lu$Olsen_P_mg_kg
# par(mfrow=c(1,2))
# normality$Olsen_P_mg_kg
mt_4 %>% group_by(landuse) %>% ggplot(aes(x=landuse, y=Olsen_P_mg_kg, color=landuse)) + geom_boxplot() + theme(legend.position='none')
# plot(fitted(models$Olsen_P_mg_kg, res))
qqPlot(residuals(models$Olsen_P_mg_kg))
# cld(lsmeans(models$Olsen_P_mg_kg,~ landuse, adjust="tukey"), Letters = c(letters))
# shapiro.test(residuals(models$Olsen_P_mg_kg))
```

**Olsen P conclusion**  
Equal variances, normal residuals shapiro-wilk, QQ-plot looks good! Conclusion: use non-transformed data in linear mixed model.  
- p-value = `r tidy(models$Olsen_P_mg_kg)$p.value[2]`  
- t-value = `r tidy(models$Olsen_P_mg_kg)$statistic[2]`  
- F-value = `r tidy(models$Olsen_P_mg_kg)$statistic[2]^2`  

### earthworms_2022

``` {R data check earthworms_2022, fig.dim=c(3,5)}
mt_4 %>% group_by(landuse, location) %>% summarize(mean=mean(earthworms_2022, na.rm=TRUE),sd=sd(earthworms_2022, na.rm=TRUE),var=var(earthworms_2022, na.rm=TRUE))
# variances_loc_lu$earthworms_2022
# par(mfrow=c(1,2))
# normality$earthworms_2022
mt_4 %>% group_by(landuse) %>% ggplot(aes(x=landuse, y=earthworms_2022, color=landuse)) + geom_boxplot() + theme(legend.position='none')
# plot(fitted(models$earthworms_2022, res))
qqPlot(residuals(models$earthworms_2022))
# cld(lsmeans(models$earthworms_2022,~ landuse, adjust="tukey"), Letters = c(letters))
# shapiro.test(residuals(models$earthworms_2022))
anova(models$earthworms_2022)

# Log transformation
# var_log_ew <- leveneTest(log(earthworms_2022) ~ landuse * location, data=mt_4)
# mod_log_ew <- lmer(log(earthworms_2022+0.001) ~ landuse + (1|location), data=mt_4,
#                   na.action = "na.omit")
# qqPlot(residuals(mod_log_P))

```

**Earthworm total abundance conclusion:**  
Non-equal variances (p = `r variances_loc_lu$earthworms_2022$"Pr(>F)"[1]`). But boxplot doesn't show it that much? Normal residuals from shapiro, QQ-plot looks a bit weird. Log transformation shows same extreme non-equal variances...
gls()?

### biomass_ew_total

``` {R data check biomass_ew_total, fig.dim=c(3,5)}
mt_4 %>% group_by(landuse, location) %>% summarize(mean=mean(biomass_ew_total, na.rm=TRUE),sd=sd(biomass_ew_total, na.rm=TRUE),var=var(biomass_ew_total, na.rm=TRUE))
# variances_loc_lu$biomass_ew_total
# par(mfrow=c(1,2))
# normality$biomass_ew_total
mt_4 %>% group_by(landuse) %>% ggplot(aes(x=landuse, y=biomass_ew_total, color=landuse)) + geom_boxplot() + theme(legend.position='none')
# plot(fitted(models$biomass_ew_total, res))
qqPlot(residuals(models$biomass_ew_total))
# cld(lsmeans(models$biomass_ew_total,~ landuse, adjust="tukey"), Letters = c(letters))
# shapiro.test(residuals(models$biomass_ew_total))
anova(models$biomass_ew_total)

# log transform earthworm biomass
log_biomass_ew <- lmer(log(biomass_ew_total+0.001) ~ landuse + (1|location), data=mt_4, na.action = "na.omit")
leveneTest(log(biomass_ew_total) ~ landuse * location, data=mt_4) #just as significant as non-transformed data

# Generalized least squares
gls_EW <- gls(biomass_ew_total ~ landuse, data=mt_4, na.action = na.omit, weights=varPower())
# weights=varPower() 
# weights = varIdent(form= ~1|location)
# correlation = corAR1(form = ~ 1 | location)
summary(gls_EW)
anova(gls_EW)
plot(gls_EW)
# cld(lsmeans(models$gls_AMF,~ landuse, adjust="tukey"), Letters = c(letters)) doesnt work for gls()
qqPlot(residuals(gls_EW))
shapiro.test(residuals(gls_EW))

```

**Earthworm total biomass conclusion:**  
Non-equal variances (p = `r variances_loc_lu$biomass_ew_total$"Pr(>F)"[1]`), normal residuals from shapiro, QQ-plot looks fine. Log transformation shows same extreme non-equal variances..

Or gls() version???

### Springtails_nr_kg

``` {R data check Springtails_nr_kg, fig.dim=c(3,5)}
mt_4 %>% group_by(landuse, location) %>% summarize(mean=mean(Springtails_nr_kg, na.rm=TRUE),sd=sd(Springtails_nr_kg, na.rm=TRUE),var=var(Springtails_nr_kg, na.rm=TRUE))
# variances_loc_lu$Springtails_nr_kg
# par(mfrow=c(1,2))
# normality$Springtails_nr_kg
mt_4 %>% group_by(landuse) %>% ggplot(aes(x=landuse, y=Springtails_nr_kg, color=landuse)) + geom_boxplot()  + theme(legend.position='none')
# plot(fitted(models$Springtails_nr_kg, res))
qqPlot(residuals(models$Springtails_nr_kg))
# cld(lsmeans(models$Springtails_nr_kg,~ landuse, adjust="tukey"), Letters = c(letters))
# shapiro.test(residuals(models$Springtails_nr_kg))
anova(models$Springtails_nr_kg)

# Log transformation
var_log_spr <- leveneTest(log(Springtails_nr_kg) ~ landuse * location, data=mt_4)
mod_log_spr <- lmer(log(Springtails_nr_kg) ~ landuse + (1|location), data=mt_4,
                  na.action = "na.omit")
# qqPlot(residuals(mod_log_spr))

```

**Springtail conclusions**  
Non-equal variances (p=`r variances_loc_lu$Springtails_nr_kg$"Pr(>F)"[1]`), normal residuals from shapiro. QQ-plot looks good. Transformation with log/srqt doesn't help. 

### Mites_oribatid_kg

``` {R data check Mites_oribatid_kg, fig.dim=c(3,5)}
mt_4 %>% group_by(landuse, location) %>% summarize(mean=mean(Mites_oribatid_kg, na.rm=TRUE),sd=sd(Mites_oribatid_kg, na.rm=TRUE),var=var(Mites_oribatid_kg, na.rm=TRUE))
# variances_loc_lu$Mites_oribatid_kg
# par(mfrow=c(1,2))
# normality$Mites_oribatid_kg
mt_4 %>% group_by(landuse) %>% ggplot(aes(x=landuse, y=Mites_oribatid_kg, color=landuse)) + geom_boxplot()  + theme(legend.position='none')
# plot(fitted(models$Mites_oribatid_kg, res))
qqPlot(residuals(models$Mites_oribatid_kg))
# cld(lsmeans(models$Mites_oribatid_kg,~ landuse, adjust="tukey"), Letters = c(letters))
shapiro.test(residuals(models$Mites_oribatid_kg))
anova(models$Mites_oribatid_kg)

# Log transformation
# var_log_ori <- leveneTest(log(Mites_oribatid_kg) ~ landuse * location, data=mt_4)
mod_log_ori <- lmer(log(Mites_oribatid_kg+0.0001) ~ landuse + (1|location), data=mt_4,
                  na.action = "na.omit")
# qqPlot(residuals(mod_log_spr))
```

**Oribatid mites conclusion**  
Non-equal variances (p=`r variances_loc_lu$Mites_oribatid_kg$"Pr(>F)"[1]`), non-normal residuals from shapiro-wilk (p=`r round(shapiro.test(residuals(models$Mites_oribatid_kg))$p.value, digits=3)`). But QQ-plot looks good (1 outlier). Transformation with log/srqt doesn't help. 

### Mites_other_kg

``` {R data check Mites_other_kg, fig.dim=c(3,5)}
mt_4 %>% group_by(landuse, location) %>% summarize(mean=mean(Mites_other_kg, na.rm=TRUE),sd=sd(Mites_other_kg, na.rm=TRUE),var=var(Mites_other_kg, na.rm=TRUE))
# variances_loc_lu$Mites_other_kg
# par(mfrow=c(1,2))
# normality$Mites_other_kg
mt_4 %>% group_by(landuse) %>% ggplot(aes(x=landuse, y=Mites_other_kg, color=landuse)) + geom_boxplot() + theme(legend.position='none')
# plot(fitted(models$Mites_other_kg, res))
qqPlot(residuals(models$Mites_other_kg))
shapiro.test(residuals(models$Mites_other_kg))
anova(models$Mites_other_kg)

# Log transformation
var_log_mit <- leveneTest(log(Mites_other_kg) ~ landuse * location, data=mt_4)
mod_log_mit <- lmer(log(Mites_other_kg+0.0001) ~ landuse + (1|location), data=mt_4,
                  na.action = "na.omit")
# qqPlot(residuals(mod_log_spr))

```

**Other mites conclusion:**  
Non-equal variances (p=`r variances_loc_lu$Mites_other_kg$"Pr(>F)"[1]`), non-normal residuals from shapiro-wilk (p=`r round(shapiro.test(residuals(models$Mites_other_kg))$p.value, digits=3)`). But QQ-plot looks good (1 outlier). But QQ-plot looks good (1 outlier). Transformation with log/srqt doesn't help. 


### Bacteria_total

``` {R data check Bacteria_total, fig.dim=c(3,5)}
mt_4 %>% group_by(landuse, location) %>% summarize(mean=mean(Bacteria_total),sd=sd(Bacteria_total),var=var(Bacteria_total))
variances_loc_lu$Bacteria_total
# par(mfrow=c(1,2))
# normality$Bacteria_total
mt_4 %>% group_by(landuse) %>% ggplot(aes(x=landuse, y=Bacteria_total, color=landuse)) + geom_boxplot() + theme(legend.position='none')
# plot(fitted(models$Bacteria_total, res))
qqPlot(residuals(models$Bacteria_total))
# shapiro.test(residuals(models$Bacteria_total))
anova(models$Bacteria_total)
```

**Total bacteria conclusion:**  
Equal variances, normal residuals with shapiro. QQ-plot looks good. Conclusion: use non-transformed data in linear mixed model.  
- p-value = `r tidy(models$Bacteria_total)$p.value[2]`  
- t-value = `r tidy(models$Bacteria_total)$statistic[2]`  
- F-value = `r tidy(models$Bacteria_total)$statistic[2]^2`  

### Microbial

``` {R data check Microbial, fig.dim=c(3,5)}
mt_4 %>% group_by(landuse, location) %>% summarize(mean=mean(Microbial),sd=sd(Microbial),var=var(Microbial))
# variances_loc_lu$Microbial
# par(mfrow=c(1,2))
# normality$Microbial
mt_4 %>% group_by(landuse) %>% ggplot(aes(x=landuse, y=Microbial, color=landuse)) + geom_boxplot() + theme(legend.position='none')
# plot(fitted(models$Microbial, res))
qqPlot(residuals(models$Microbial))
# shapiro.test(residuals(models$Microbial))
anova(models$Microbial)
```

**Total microbial conclusion:**  
Equal variances, normal residuals with shapiro. QQ-plot looks good. Conclusion: use non-transformed data in linear mixed model.  
- p-value = `r tidy(models$Microbial)$p.value[2]`  
- t-value = `r tidy(models$Microbial)$statistic[2]`  
- F-value = `r tidy(models$Microbial)$statistic[2]^2`  

### Actinobacteria_total

``` {R data check Actinobacteria_total, fig.dim=c(3,5)}
mt_4 %>% group_by(landuse, location) %>% summarize(mean=mean(Actinobacteria_total),sd=sd(Actinobacteria_total),var=var(Actinobacteria_total))
variances_loc_lu$Actinobacteria_total
# par(mfrow=c(1,2))
# normality$Actinobacteria_total
mt_4 %>% group_by(landuse) %>% ggplot(aes(x=landuse, y=Actinobacteria_total, color=landuse)) + geom_boxplot() + theme(legend.position='none')
# plot(fitted(models$Actinobacteria_total, res))
qqPlot(residuals(models$Actinobacteria_total))
# shapiro.test(residuals(models$Actinobacteria_total))
anova(models$Actinobacteria_total)
```

**Total actinobacteria conclusion:**  
Equal variances, normal residuals with shapiro. QQ-plot looks good. Conclusion: use non-transformed data in linear mixed model.  
- p-value = `r tidy(models$Actinobacteria_total)$p.value[2]`  
- t-value = `r tidy(models$Actinobacteria_total)$statistic[2]`  
- F-value = `r tidy(models$Actinobacteria_total)$statistic[2]^2`  

### Fungi_total

``` {R data check Fungi_total, fig.dim=c(3,5)}
mt_4 %>% group_by(landuse, location) %>% summarize(mean=mean(Fungi_total),sd=sd(Fungi_total),var=var(Fungi_total))
# variances_loc_lu$Fungi_total
# par(mfrow=c(1,2))
# normality$Fungi_total
mt_4 %>% group_by(landuse) %>% ggplot(aes(x=landuse, y=Fungi_total, color=landuse)) + geom_boxplot() + theme(legend.position='none')
# plot(fitted(models$Fungi_total, res))
qqPlot(residuals(models$Fungi_total))
shapiro.test(residuals(models$Fungi_total))
anova(models$Fungi_total)
```

**Total fungi conclusion:**  
Equal variances, normal residuals with shapiro. QQ-plot looks good. Conclusion: use non-transformed data in linear mixed model.  
- p-value = `r tidy(models$Fungi_total)$p.value[2]`  
- t-value = `r tidy(models$Fungi_total)$statistic[2]`  
- F-value = `r tidy(models$Fungi_total)$statistic[2]^2`  

### Total_plfa

``` {R data check Total_plfa, fig.dim=c(3,5)}
mt_4 %>% group_by(landuse, location) %>% summarize(mean=mean(Total_plfa),sd=sd(Total_plfa),var=var(Total_plfa))
variances_loc_lu$Total_plfa
# par(mfrow=c(1,2))
# normality$Total_plfa
mt_4 %>% group_by(landuse) %>% ggplot(aes(x=landuse, y=Total_plfa, color=landuse)) + geom_boxplot() + theme(legend.position='none')
# plot(fitted(models$Total_plfa, res))
qqPlot(residuals(models$Total_plfa))
# shapiro.test(residuals(models$Total_plfa))
anova(models$Total_plfa)
```

**Total PLFA conclusion:**  
Equal variances, normal residuals with shapiro. QQ-plot looks good. Conclusion: use non-transformed data in linear mixed model.  
- p-value = `r tidy(models$Total_plfa)$p.value[2]`  
- t-value = `r tidy(models$Total_plfa)$statistic[2]`  
- F-value = `r tidy(models$Total_plfa)$statistic[2]^2`  

### AMF_NLFA

``` {R data check AMF_NLFA, fig.dim=c(3,5)}
mt_4 %>% group_by(location,landuse) %>% summarize(mean=mean(AMF_NLFA),sd=sd(AMF_NLFA),var=var(AMF_NLFA))
variances_loc_lu$AMF_NLFA
# par(mfrow=c(1,2))
# normality$AMF_NLFA
mt_4 %>% group_by(landuse) %>% ggplot(aes(x=landuse, y=AMF_NLFA, color=landuse)) + geom_boxplot() + theme(legend.position='none')
# plot(fitted(models$AMF_NLFA, res))
qqPlot(residuals(models$AMF_NLFA))
shapiro.test(residuals(models$AMF_NLFA))
anova(models$AMF_NLFA)

# log transform AMF
# gghistogram(log(mt_4$AMF_NLFA),  fill = 'lightgrey', na.rm=TRUE)
# mt_4 %>% group_by(landuse) %>% ggplot(aes(x=landuse, y=log(AMF_NLFA), color=landuse)) + geom_boxplot()
# amf_transf <- lmer(log(AMF_NLFA) ~ landuse + (1|location), data=mt_4, na.action = "na.omit")
var_log_amf <- leveneTest(log(AMF_NLFA) ~ landuse * location, data=mt_4) # little bit less significant...but still significant for sure
# anova(amf_transf)
# summary(amf_transf)
# cld(lsmeans(amf_transf,~ landuse,adjust="tukey"), Letters = c(letters))
# shapiro.test(residuals(amf_transf))
# qqPlot(residuals(amf_transf))

# Generalized least squares
gls_AMF <- gls(AMF_NLFA ~ landuse, data=mt_4, na.action = na.omit, weights=varPower())
# weights=varPower() 
# weights = varIdent(form= ~1|location)
# correlation = corAR1(form = ~ 1 | location)
summary(gls_AMF)
anova(gls_AMF)
plot(gls_AMF)
# cld(lsmeans(models$gls_AMF,~ landuse, adjust="tukey"), Letters = c(letters)) doesnt work for gls()
qqPlot(residuals(gls_AMF))
shapiro.test(residuals(gls_AMF))
# 
# ## Run the following lines. These introduce methods for 'gls' objects.
# model.matrix.gls<-function(object,...){
# 	model.matrix(terms(object),data=getData(object),...)
# }
# model.frame.gls<-function(object,...){
# 	model.frame(formula(object),data=getData(object),...)
# }
# terms.gls<-function(object,...){
# 	terms(model.frame(object),...)
# }
# # The line below gives pairwise comparisons now.  Note that the above
# # performs t-tests for all pairwise differences.
# multCompTukey <- glht(gls_AMF, linfct = mcp(landuse = "Tukey"))

```

**Total AMF (NLFA) conclusion:**  
Non-equal variances (p=`r variances_loc_lu$AMF_NLFA$"Pr(>F)"[1]`), normal residuals with shapiro. QQ-plot looks good. 
Log transforming AMF data makes unequal variances a bit less extreme (p=`r var_log_amf$"Pr(>F)"[1]`) but still significant. 
